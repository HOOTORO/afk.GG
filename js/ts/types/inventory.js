import { elTag, fetchData, log, newEl, safeSum } from "../components/helper.js";
import Relic from "./relic.js";
import { Core } from "./core.js";
import { Virtue } from "./virtue.js";
import { AbExSellModifier, RelicBase } from "../model/constants.js";
export const Tree = await fetchData("json/duratree.json");
const relicData = await fetchData("json/relic.json");
export default class Inventory {
    core;
    tree = [];
    bag = [];
    constructor() {
        relicData.forEach((x) => {
            this.bag.push(new Relic(x.icon, x.name, x.id, x.cost, x.recipe));
        });
        Tree.forEach((x) => {
            this.tree.push(new Virtue(x.icon, x.name, x.id, x.class, x.acronym));
        });
        this.core = new Core(this.bag, this.tree);
    }
    Relics(tier) {
        if (tier) {
            return this.bag.filter((r) => r.Tier() === tier);
        }
        else {
            return this.bag;
        }
    }
    Relic(id) {
        return this.Relics().find((r) => r.id === id);
    }
    price(rel) {
        if (rel.id > RelicBase) {
            return (rel.cost +
                rel.recipe.map((x) => this.price(this.Relic(x))).reduce((a, b) => a + b));
        }
        else {
            return rel.cost;
        }
    }
    components(r) {
        if (r.recipe.length > 1) {
            return [r].concat(r.recipe.map((x) => this.components(this.Relic(x))).flat());
        }
        else {
            return [r];
        }
    }
    componentsDia(r) {
        if (r.recipe.length > 1) {
            const parent = r.html();
            parent.innerHTML += "|";
            [...new Set(r.recipe)]
                .map((x) => this.componentsDia(this.Relic(x)))
                .forEach((x) => parent.appendChild(x));
            return parent;
        }
        else {
            return r.html();
        }
    }
    sell(r) {
        return this.price(r) * AbExSellModifier;
    }
    upgradeCost() {
        return safeSum(this.core.wanted().map((x) => this.price(x)));
    }
    syncGoals() {
        const need = this.core.wanted().flatMap((x) => this.components(x));
        return this.droppedRelics().map((r) => {
            r.reserve = need.filter((f) => r.id === f.id).length;
            return r;
        });
    }
    droppedRelics() {
        return this.bag.filter((x) => x.amount > 0);
    }
    canBeSold() {
        return this.syncGoals().filter((x) => x.reserve < x.amount);
    }
    goalRequired() {
        return this.syncGoals().filter((x) => x.reserve > 0);
    }
    sellOut() {
        return safeSum(this.canBeSold().map((x) => this.sell(x)));
    }
    reservedValue() {
        return safeSum(this.syncGoals().map((x) => this.price(x) * Math.min(x.amount, x.reserve)));
    }
    html() {
        const coreContainer = newEl(elTag.Div, { class: "blessed-core" });
        this.tree.forEach((v) => {
            const equipped = this.core.all(v.dura);
            const container = newEl("span", {
                class: `core-virtue ${v.name}`,
                style: `background-image: url(${v.icon});`,
            });
            const relicTree = newEl("div", { class: `relic` }, `<span class="core-virtue__label">equip</span>`);
            const goal = newEl("div", { class: `goal` }, `<span class="core-virtue__label">goal</span>`);
            equipped.forEach((t, i) => {
                relicTree.appendChild(t.html());
                goal.appendChild(t.HTMLGoal());
            });
            container.appendChild(relicTree);
            container.appendChild(goal);
            coreContainer.appendChild(container);
        });
        coreContainer.addEventListener("click", (e) => {
            if (e.target instanceof HTMLImageElement) {
                const imgClasses = e.target.parentElement.classList, goal = imgClasses.contains("goal"), virtue = imgClasses.item(2), slot = parseInt(imgClasses.item(1).substring(4)), itemId = imgClasses.item(0).substring(5);
                const rel = this.core.next(virtue, slot, goal);
                if (goal) {
                    e.target.parentElement.replaceWith(rel.HTMLGoal());
                }
                else {
                    e.target.parentElement.replaceWith(rel.html());
                }
                rel.update();
                const r = this.core.getById(parseInt(itemId));
                const compo = this.components(r).map((x) => x.id);
                log(`Relic #${r.id} components: [${compo}] `);
            }
        });
        return coreContainer;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW52ZW50b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3R5cGVzL2ludmVudG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hGLE9BQU8sS0FBSyxNQUFNLFlBQVksQ0FBQztBQUMvQixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBZSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXBFLE1BQU0sQ0FBQyxNQUFNLElBQUksR0FBYSxNQUFNLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ3BFLE1BQU0sU0FBUyxHQUFZLE1BQU0sU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFOUQsTUFBTSxDQUFDLE9BQU8sT0FBTyxTQUFTO0lBQzVCLElBQUksQ0FBTztJQUNYLElBQUksR0FBYSxFQUFFLENBQUM7SUFDcEIsR0FBRyxHQUFZLEVBQUUsQ0FBQztJQUVsQjtRQUNFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUN0QixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ25FLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxD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QUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDL0MsSUFBSSxJQUFJLEVBQUUsQ0FBQztvQkFDVCxDQUFDLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7Z0JBQ3JELENBQUM7cUJBQU0sQ0FBQztvQkFDTixDQUFDLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQ2pELENBQUM7Z0JBQ0QsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNiLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNsRCxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxpQkFBaUIsS0FBSyxJQUFJLENBQUMsQ0FBQztZQUNoRCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbFRhZywgZmV0Y2hEYXRhLCBsb2csIG5ld0VsLCBzYWZlU3VtIH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvaGVscGVyLmpzXCI7XG5pbXBvcnQgUmVsaWMgZnJvbSBcIi4vcmVsaWMuanNcIjtcbmltcG9ydCB7IENvcmUgfSBmcm9tIFwiLi9jb3JlLmpzXCI7XG5pbXBvcnQgeyBEdXJhc1ZpcnR1ZSwgVmlydHVlIH0gZnJvbSBcIi4vdmlydHVlLmpzXCI7XG5pbXBvcnQgeyBBYkV4U2VsbE1vZGlmaWVyLCBSZWxpY0Jhc2UgfSBmcm9tIFwiLi4vbW9kZWwvY29uc3RhbnRzLmpzXCI7XG5cbmV4cG9ydCBjb25zdCBUcmVlOiBWaXJ0dWVbXSA9IGF3YWl0IGZldGNoRGF0YShcImpzb24vZHVyYXRyZWUuanNvblwiKTtcbmNvbnN0IHJlbGljRGF0YTogUmVsaWNbXSA9IGF3YWl0IGZldGNoRGF0YShcImpzb24vcmVsaWMuanNvblwiKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW52ZW50b3J5IHtcbiAgY29yZTogQ29yZTtcbiAgdHJlZTogVmlydHVlW10gPSBbXTtcbiAgYmFnOiBSZWxpY1tdID0gW107XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgcmVsaWNEYXRhLmZvckVhY2goKHgpID0+IHtcbiAgICAgIHRoaXMuYmFnLnB1c2gobmV3IFJlbGljKHguaWNvbiwgeC5uYW1lLCB4LmlkLCB4LmNvc3QsIHgucmVjaXBlKSk7XG4gICAgfSk7XG4gICAgVHJlZS5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICB0aGlzLnRyZWUucHVzaChuZXcgVmlydHVlKHguaWNvbiwgeC5uYW1lLCB4LmlkLCB4LmNsYXNzLCB4LmFjcm9ueW0pKTtcbiAgICB9KTtcbiAgICB0aGlzLmNvcmUgPSBuZXcgQ29yZSh0aGlzLmJhZywgdGhpcy50cmVlKTtcbiAgfVxuXG4gIHB1YmxpYyBSZWxpY3MoKTogUmVsaWNbXTtcbiAgcHVibGljIFJlbGljcyh0aWVyOiBudW1iZXIpOiBSZWxpY1tdO1xuICBwdWJsaWMgUmVsaWNzKHRpZXI/OiBudW1iZXIpOiBSZWxpY1tdIHtcbiAgICBpZiAodGllcikge1xuICAgICAgcmV0dXJuIHRoaXMuYmFnLmZpbHRlcigocikgPT4gci5UaWVyKCkgPT09IHRpZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5iYWc7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBSZWxpYyhpZDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuUmVsaWNzKCkuZmluZCgocikgPT4gci5pZCA9PT0gaWQpO1xuICB9XG4gIHByaWNlKHJlbDogUmVsaWMpOiBudW1iZXIge1xuICAgIGlmIChyZWwuaWQgPiBSZWxpY0Jhc2UpIHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIHJlbC5jb3N0ICtcbiAgICAgICAgcmVsLnJlY2lwZS5tYXAoKHgpID0+IHRoaXMucHJpY2UodGhpcy5SZWxpYyh4KSkpLnJlZHVjZSgoYSwgYikgPT4gYSArIGIpXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVsLmNvc3Q7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50cyhyOiBSZWxpYyk6IFJlbGljW10ge1xuICAgIGlmIChyLnJlY2lwZS5sZW5ndGggPiAxKSB7XG4gICAgICByZXR1cm4gW3JdLmNvbmNhdChcbiAgICAgICAgci5yZWNpcGUubWFwKCh4KSA9PiB0aGlzLmNvbXBvbmVudHModGhpcy5SZWxpYyh4KSkpLmZsYXQoKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFtyXTtcbiAgICB9XG4gIH1cbiAgY29tcG9uZW50c0RpYShyOiBSZWxpYyk6IEhUTUxFbGVtZW50IHtcbiAgICBpZiAoci5yZWNpcGUubGVuZ3RoID4gMSkge1xuICAgICAgY29uc3QgcGFyZW50ID0gci5odG1sKCk7XG4gICAgICBwYXJlbnQuaW5uZXJIVE1MICs9IFwifFwiO1xuICAgICAgWy4uLm5ldyBTZXQoci5yZWNpcGUpXVxuICAgICAgICAubWFwKCh4KSA9PiB0aGlzLmNvbXBvbmVudHNEaWEodGhpcy5SZWxpYyh4KSkpXG4gICAgICAgIC5mb3JFYWNoKCh4KSA9PiBwYXJlbnQuYXBwZW5kQ2hpbGQoeCkpO1xuICAgICAgcmV0dXJuIHBhcmVudDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHIuaHRtbCgpO1xuICAgIH1cbiAgfVxuXG4gIHNlbGwocjogUmVsaWMpIHtcbiAgICByZXR1cm4gdGhpcy5wcmljZShyKSAqIEFiRXhTZWxsTW9kaWZpZXI7XG4gIH1cbiAgdXBncmFkZUNvc3QoKSB7XG4gICAgcmV0dXJuIHNhZmVTdW0odGhpcy5jb3JlLndhbnRlZCgpLm1hcCgoeCkgPT4gdGhpcy5wcmljZSh4KSkpO1xuICB9XG4gIHN5bmNHb2FscygpIHtcbiAgICBjb25zdCBuZWVkID0gdGhpcy5jb3JlLndhbnRlZCgpLmZsYXRNYXAoKHgpID0+IHRoaXMuY29tcG9uZW50cyh4KSk7XG4gICAgcmV0dXJuIHRoaXMuZHJvcHBlZFJlbGljcygpLm1hcCgocikgPT4ge1xuICAgICAgci5yZXNlcnZlID0gbmVlZC5maWx0ZXIoKGYpID0+IHIuaWQgPT09IGYuaWQpLmxlbmd0aDtcbiAgICAgIHJldHVybiByO1xuICAgIH0pO1xuICB9XG5cbiAgZHJvcHBlZFJlbGljcygpIHtcbiAgICByZXR1cm4gdGhpcy5iYWcuZmlsdGVyKCh4KSA9PiB4LmFtb3VudCA+IDApO1xuICB9XG4gIGNhbkJlU29sZCgpIHtcbiAgICByZXR1cm4gdGhpcy5zeW5jR29hbHMoKS5maWx0ZXIoKHgpID0+IHgucmVzZXJ2ZSA8IHguYW1vdW50KTtcbiAgfVxuICBnb2FsUmVxdWlyZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3luY0dvYWxzKCkuZmlsdGVyKCh4KSA9PiB4LnJlc2VydmUgPiAwKTtcbiAgfVxuXG4gIHNlbGxPdXQoKSB7XG4gICAgcmV0dXJuIHNhZmVTdW0odGhpcy5jYW5CZVNvbGQoKS5tYXAoKHgpID0+IHRoaXMuc2VsbCh4KSkpO1xuICB9XG4gIHJlc2VydmVkVmFsdWUoKSB7XG4gICAgcmV0dXJuIHNhZmVTdW0oXG4gICAgICB0aGlzLnN5bmNHb2FscygpLm1hcCgoeCkgPT4gdGhpcy5wcmljZSh4KSAqIE1hdGgubWluKHguYW1vdW50LCB4LnJlc2VydmUpKVxuICAgICk7XG4gIH1cblxuICBodG1sKCk6IEhUTUxFbGVtZW50IHtcbiAgICBjb25zdCBjb3JlQ29udGFpbmVyID0gbmV3RWwoZWxUYWcuRGl2LCB7IGNsYXNzOiBcImJsZXNzZWQtY29yZVwiIH0pO1xuXG4gICAgdGhpcy50cmVlLmZvckVhY2goKHYpID0+IHtcbiAgICAgIGNvbnN0IGVxdWlwcGVkID0gdGhpcy5jb3JlLmFsbCh2LmR1cmEpO1xuICAgICAgY29uc3QgY29udGFpbmVyID0gbmV3RWwoXCJzcGFuXCIsIHtcbiAgICAgICAgY2xhc3M6IGBjb3JlLXZpcnR1ZSAke3YubmFtZX1gLFxuICAgICAgICBzdHlsZTogYGJhY2tncm91bmQtaW1hZ2U6IHVybCgke3YuaWNvbn0pO2AsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlbGljVHJlZSA9IG5ld0VsKFxuICAgICAgICBcImRpdlwiLFxuICAgICAgICB7IGNsYXNzOiBgcmVsaWNgIH0sXG4gICAgICAgIGA8c3BhbiBjbGFzcz1cImNvcmUtdmlydHVlX19sYWJlbFwiPmVxdWlwPC9zcGFuPmBcbiAgICAgICk7XG4gICAgICBjb25zdCBnb2FsID0gbmV3RWwoXG4gICAgICAgIFwiZGl2XCIsXG4gICAgICAgIHsgY2xhc3M6IGBnb2FsYCB9LFxuICAgICAgICBgPHNwYW4gY2xhc3M9XCJjb3JlLXZpcnR1ZV9fbGFiZWxcIj5nb2FsPC9zcGFuPmBcbiAgICAgICk7XG4gICAgICBlcXVpcHBlZC5mb3JFYWNoKCh0LCBpKSA9PiB7XG4gICAgICAgIHJlbGljVHJlZS5hcHBlbmRDaGlsZCh0Lmh0bWwoKSk7XG5cbiAgICAgICAgZ29hbC5hcHBlbmRDaGlsZCh0LkhUTUxHb2FsKCkpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChyZWxpY1RyZWUpO1xuICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGdvYWwpO1xuICAgICAgY29yZUNvbnRhaW5lci5hcHBlbmRDaGlsZChjb250YWluZXIpO1xuICAgIH0pO1xuXG4gICAgY29yZUNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGUpID0+IHtcbiAgICAgIGlmIChlLnRhcmdldCBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpIHtcbiAgICAgICAgY29uc3QgaW1nQ2xhc3NlcyA9IGUudGFyZ2V0LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LFxuICAgICAgICAgIGdvYWwgPSBpbWdDbGFzc2VzLmNvbnRhaW5zKFwiZ29hbFwiKSxcbiAgICAgICAgICB2aXJ0dWUgPSA8RHVyYXNWaXJ0dWU+aW1nQ2xhc3Nlcy5pdGVtKDIpLFxuICAgICAgICAgIHNsb3QgPSBwYXJzZUludChpbWdDbGFzc2VzLml0ZW0oMSkuc3Vic3RyaW5nKDQpKSxcbiAgICAgICAgICBpdGVtSWQgPSBpbWdDbGFzc2VzLml0ZW0oMCkuc3Vic3RyaW5nKDUpO1xuXG4gICAgICAgIGNvbnN0IHJlbCA9IHRoaXMuY29yZS5uZXh0KHZpcnR1ZSwgc2xvdCwgZ29hbCk7XG4gICAgICAgIGlmIChnb2FsKSB7XG4gICAgICAgICAgZS50YXJnZXQucGFyZW50RWxlbWVudC5yZXBsYWNlV2l0aChyZWwuSFRNTEdvYWwoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZS50YXJnZXQucGFyZW50RWxlbWVudC5yZXBsYWNlV2l0aChyZWwuaHRtbCgpKTtcbiAgICAgICAgfVxuICAgICAgICByZWwudXBkYXRlKCk7XG4gICAgICAgIGNvbnN0IHIgPSB0aGlzLmNvcmUuZ2V0QnlJZChwYXJzZUludChpdGVtSWQpKTtcbiAgICAgICAgY29uc3QgY29tcG8gPSB0aGlzLmNvbXBvbmVudHMocikubWFwKCh4KSA9PiB4LmlkKTtcbiAgICAgICAgbG9nKGBSZWxpYyAjJHtyLmlkfSBjb21wb25lbnRzOiBbJHtjb21wb31dIGApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjb3JlQ29udGFpbmVyO1xuICB9XG59XG4iXX0=