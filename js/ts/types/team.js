import { fetchData, newEl, savedObj, storedValue, } from "../components/helper.js";
import { elTag } from "../model/constants.js";
import { Hero } from "./hero.js";
import { Pet } from "./pet.js";
const teamWrap = "team";
const heroSelectId = "hero-selection";
const petSelectId = "pet-sele";
export const HeroesData = await fetchData("json/heroes.json");
export const Beasts = await fetchData("json/pets.json");
const Heroes = HeroesData.map((x) => new Hero(x.id, x.icon, x.heroType, x.heroClass, x.role, x.faction, x.slug));
const puppies = Beasts.map((x) => new Pet(x.id, x.icon, x.name));
export class Team {
    team;
    beast;
    target;
    #wrap;
    roster = [];
    _max = 5;
    damage;
    food;
    constructor(mountId, team, beast, target) {
        this.team = team;
        this.beast = beast;
        this.target = target;
        const heroSaved = savedObj("team", []);
        if (heroSaved.length > 0) {
            heroSaved.forEach((v, i) => {
                this.roster.push(new Hero(v.id, v.icon, v.heroType, v.heroClass, v.role, v.faction, v.slug));
            });
        }
        this.beast = savedObj("team-pet", new Pet(0, "1", "0"));
        this.food = savedObj("min-food", 0);
        this.init(mountId);
    }
    init(mid) {
        this.#wrap = newEl(elTag.Div, { class: teamWrap });
        const allPets = this.inputsContainer(petSelectId, puppies), allHeroes = this.inputsContainer(heroSelectId, Heroes);
        this.#wrap.appendChild(allPets);
        this.#wrap.appendChild(allHeroes);
        this.#wrap.addEventListener("input", (e) => {
            if (e.target instanceof HTMLInputElement &&
                e.target.className === "beast") {
                this.petHandler(e);
            }
            else {
                this.heroHandler(e);
            }
            this.update();
        });
    }
    update() {
        storedValue("team", this.roster);
        storedValue("team-pet", this.beast);
    }
    isInTeam(hero) {
        return this.roster.findIndex((x) => x.id === hero.id) > -1;
    }
    add(h) {
        if (this.roster?.length < this._max) {
            this.roster.push(h);
            return true;
        }
        else {
            console.log("Team is full!");
            return false;
        }
    }
    remove(h) {
        const idx = this.roster.findIndex((x) => x.id === h.id);
        if (idx > -1) {
            this.roster.splice(idx, 1);
        }
    }
    makeAttack(dmg, c) {
        if (this.damage === undefined) {
            this.damage = [];
        }
        this.damage.push([dmg, c]);
    }
    inputsContainer(id, data) {
        const container = newEl("div", { class: id });
        container.appendChild(newEl("h2", {}, `CHOOSE ${id.split("-")[0].toUpperCase()}`));
        const ul = document.createElement("ul");
        for (const h of data) {
            const li = document.createElement("li"), checkBox = h.html();
            li.appendChild(checkBox);
            ul.appendChild(li);
            if (h instanceof Pet && this.beast && this.beast.id === h.id) {
                checkBox.getElementsByTagName("input")[0].checked = true;
            }
            if (h instanceof Hero &&
                this.roster.length > 0 &&
                this.roster.findIndex((x) => x.id === h.id) > -1) {
                checkBox.getElementsByTagName("input")[0].checked = true;
            }
        }
        container.appendChild(ul);
        return container;
    }
    heroHandler(e) {
        const tg = e.target;
        const Hero = Heroes.find((x) => x.id === parseInt(tg.id.split("-")[1]));
        if (tg.checked && !this.isInTeam(Hero)) {
            if (!this.add(Hero)) {
                tg.checked = !tg.checked;
            }
        }
        if (!tg.checked && this.isInTeam(Hero)) {
            this.remove(Hero);
        }
    }
    petHandler(e) {
        const tg = e.target;
        const petGroup = document.querySelectorAll(`.${petSelectId} input`);
        const clickedPet = Beasts.find((x) => x.name.includes(tg.id.substring(7)));
        petGroup.forEach((x) => {
            if (!x.id.includes(clickedPet.name))
                x.checked = false;
        });
        this.beast = clickedPet;
        tg.checked = !tg.checked;
    }
    appendResultRow(body, dps, duraMight, duraFort, duraCelerity, duraSorcery, duraSustenance, c = "") {
        const resultRow = newEl(elTag.tr), team = newEl(elTag.td, {}), pet = newEl(elTag.td, {}), might = newEl(elTag.td, {}, `${duraMight}`), fort = newEl(elTag.td, {}, `${duraFort}`), celerity = newEl(elTag.td, {}, `${duraCelerity}`), sorcery = newEl(elTag.td, {}, `${duraSorcery}`), sustenance = newEl(elTag.td, {}, `${duraSustenance}`), comment = newEl(elTag.td, {}, c), damage = newEl(elTag.td, {}, `${dps}B`);
        this.roster.forEach((x) => team.appendChild(x.img()));
        pet.appendChild(this.beast.img());
        resultRow.style.verticalAlign = "middle";
        resultRow.appendChild(team);
        resultRow.appendChild(pet);
        resultRow.appendChild(might);
        resultRow.appendChild(fort);
        resultRow.appendChild(celerity);
        resultRow.appendChild(sorcery);
        resultRow.appendChild(sustenance);
        resultRow.appendChild(damage);
        resultRow.appendChild(comment);
        this.makeAttack(dps, c);
        body.appendChild(resultRow);
    }
    mount(elid) {
        document.getElementById(elid).appendChild(this.#wrap);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy90eXBlcy90ZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLFFBQVEsRUFDUixXQUFXLEdBQ1osTUFBTSx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDOUMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRS9CLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQztBQUN4QixNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQztBQUN0QyxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUM7QUFFL0IsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFXLE1BQU0sU0FBUyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDdEUsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFVLE1BQU0sU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFFL0QsTUFBTSxNQUFNLEdBQVcsVUFBVSxDQUFDLEdBQUcsQ0FDbkMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUNKLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FDN0UsQ0FBQztBQUNGLE1BQU0sT0FBTyxHQUFVLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFB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QUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZmV0Y2hEYXRhLFxuICBuZXdFbCxcbiAgc2F2ZWRPYmosXG4gIHN0b3JlZFZhbHVlLFxufSBmcm9tIFwiLi4vY29tcG9uZW50cy9oZWxwZXIuanNcIjtcbmltcG9ydCB7IGVsVGFnIH0gZnJvbSBcIi4uL21vZGVsL2NvbnN0YW50cy5qc1wiO1xuaW1wb3J0IHsgSGVybyB9IGZyb20gXCIuL2hlcm8uanNcIjtcbmltcG9ydCB7IFBldCB9IGZyb20gXCIuL3BldC5qc1wiO1xuXG5jb25zdCB0ZWFtV3JhcCA9IFwidGVhbVwiO1xuY29uc3QgaGVyb1NlbGVjdElkID0gXCJoZXJvLXNlbGVjdGlvblwiO1xuY29uc3QgcGV0U2VsZWN0SWQgPSBcInBldC1zZWxlXCI7XG5cbmV4cG9ydCBjb25zdCBIZXJvZXNEYXRhOiBIZXJvW10gPSBhd2FpdCBmZXRjaERhdGEoXCJqc29uL2hlcm9lcy5qc29uXCIpO1xuZXhwb3J0IGNvbnN0IEJlYXN0czogUGV0W10gPSBhd2FpdCBmZXRjaERhdGEoXCJqc29uL3BldHMuanNvblwiKTtcblxuY29uc3QgSGVyb2VzOiBIZXJvW10gPSBIZXJvZXNEYXRhLm1hcChcbiAgKHgpID0+XG4gICAgbmV3IEhlcm8oeC5pZCwgeC5pY29uLCB4Lmhlcm9UeXBlLCB4Lmhlcm9DbGFzcywgeC5yb2xlLCB4LmZhY3Rpb24sIHguc2x1Zylcbik7XG5jb25zdCBwdXBwaWVzOiBQZXRbXSA9IEJlYXN0cy5tYXAoKHgpID0+IG5ldyBQZXQoeC5pZCwgeC5pY29uLCB4Lm5hbWUpKTtcblxuZXhwb3J0IGNsYXNzIFRlYW0ge1xuICAjd3JhcDogSFRNTEVsZW1lbnQ7XG4gIHJvc3RlcjogSGVyb1tdID0gW107XG4gIHByaXZhdGUgX21heDogbnVtYmVyID0gNTtcbiAgZGFtYWdlOiBbbnVtYmVyLCBzdHJpbmc/XVtdO1xuXG4gIGZvb2Q6IG51bWJlcjtcblxuICBjb25zdHJ1Y3Rvcihtb3VudElkOiBzdHJpbmcpO1xuICBjb25zdHJ1Y3RvcihcbiAgICBtb3VudElkOiBzdHJpbmcsXG4gICAgcHVibGljIHRlYW0/OiBIZXJvW10sXG4gICAgcHVibGljIGJlYXN0PzogUGV0LFxuICAgIHB1YmxpYyB0YXJnZXQ/OiBzdHJpbmdcbiAgKSB7XG4gICAgY29uc3QgaGVyb1NhdmVkOiBIZXJvW10gPSBzYXZlZE9iaihcInRlYW1cIiwgW10pO1xuICAgIGlmIChoZXJvU2F2ZWQubGVuZ3RoID4gMCkge1xuICAgICAgaGVyb1NhdmVkLmZvckVhY2goKHYsIGkpID0+IHtcbiAgICAgICAgdGhpcy5yb3N0ZXIucHVzaChcbiAgICAgICAgICBuZXcgSGVybyhcbiAgICAgICAgICAgIHYuaWQsXG4gICAgICAgICAgICB2Lmljb24sXG4gICAgICAgICAgICB2Lmhlcm9UeXBlLFxuICAgICAgICAgICAgdi5oZXJvQ2xhc3MsXG4gICAgICAgICAgICB2LnJvbGUsXG4gICAgICAgICAgICB2LmZhY3Rpb24sXG4gICAgICAgICAgICB2LnNsdWdcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmJlYXN0ID0gc2F2ZWRPYmooXCJ0ZWFtLXBldFwiLCBuZXcgUGV0KDAsIFwiMVwiLCBcIjBcIikpO1xuICAgIHRoaXMuZm9vZCA9IHNhdmVkT2JqKFwibWluLWZvb2RcIiwgMCk7XG4gICAgdGhpcy5pbml0KG1vdW50SWQpO1xuICB9XG4gIGluaXQobWlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLiN3cmFwID0gbmV3RWwoZWxUYWcuRGl2LCB7IGNsYXNzOiB0ZWFtV3JhcCB9KTtcblxuICAgIGNvbnN0IGFsbFBldHMgPSB0aGlzLmlucHV0c0NvbnRhaW5lcihwZXRTZWxlY3RJZCwgcHVwcGllcyksXG4gICAgICBhbGxIZXJvZXMgPSB0aGlzLmlucHV0c0NvbnRhaW5lcihoZXJvU2VsZWN0SWQsIEhlcm9lcyk7XG4gICAgdGhpcy4jd3JhcC5hcHBlbmRDaGlsZChhbGxQZXRzKTtcbiAgICB0aGlzLiN3cmFwLmFwcGVuZENoaWxkKGFsbEhlcm9lcyk7XG5cbiAgICB0aGlzLiN3cmFwLmFkZEV2ZW50TGlzdGVuZXIoXCJpbnB1dFwiLCAoZSkgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBlLnRhcmdldCBpbnN0YW5jZW9mIEhUTUxJbnB1dEVsZW1lbnQgJiZcbiAgICAgICAgZS50YXJnZXQuY2xhc3NOYW1lID09PSBcImJlYXN0XCJcbiAgICAgICkge1xuICAgICAgICB0aGlzLnBldEhhbmRsZXIoZSBhcyBJbnB1dEV2ZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuaGVyb0hhbmRsZXIoZSBhcyBJbnB1dEV2ZW50KTtcbiAgICAgIH1cbiAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGUoKSB7XG4gICAgc3RvcmVkVmFsdWUoXCJ0ZWFtXCIsIHRoaXMucm9zdGVyKTtcbiAgICBzdG9yZWRWYWx1ZShcInRlYW0tcGV0XCIsIHRoaXMuYmVhc3QpO1xuICB9XG4gIGlzSW5UZWFtKGhlcm86IEhlcm8pOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yb3N0ZXIuZmluZEluZGV4KCh4KSA9PiB4LmlkID09PSBoZXJvLmlkKSA+IC0xO1xuICB9XG4gIGFkZChoOiBIZXJvKSB7XG4gICAgaWYgKHRoaXMucm9zdGVyPy5sZW5ndGggPCB0aGlzLl9tYXgpIHtcbiAgICAgIHRoaXMucm9zdGVyLnB1c2goaCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coXCJUZWFtIGlzIGZ1bGwhXCIpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuICByZW1vdmUoaDogSGVybykge1xuICAgIGNvbnN0IGlkeCA9IHRoaXMucm9zdGVyLmZpbmRJbmRleCgoeCkgPT4geC5pZCA9PT0gaC5pZCk7XG4gICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICB0aGlzLnJvc3Rlci5zcGxpY2UoaWR4LCAxKTtcbiAgICB9XG4gIH1cblxuICBtYWtlQXR0YWNrKGRtZzogbnVtYmVyLCBjPzogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuZGFtYWdlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuZGFtYWdlID0gW107XG4gICAgfVxuICAgIHRoaXMuZGFtYWdlLnB1c2goW2RtZywgY10pO1xuICB9XG5cbiAgaW5wdXRzQ29udGFpbmVyKGlkOiBzdHJpbmcsIGRhdGE6IEhlcm9bXSB8IFBldFtdKSB7XG4gICAgY29uc3QgY29udGFpbmVyID0gbmV3RWwoXCJkaXZcIiwgeyBjbGFzczogaWQgfSk7XG4gICAgY29udGFpbmVyLmFwcGVuZENoaWxkKFxuICAgICAgbmV3RWwoXCJoMlwiLCB7fSwgYENIT09TRSAke2lkLnNwbGl0KFwiLVwiKVswXS50b1VwcGVyQ2FzZSgpfWApXG4gICAgKTtcbiAgICBjb25zdCB1bCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ1bFwiKTtcbiAgICBmb3IgKGNvbnN0IGggb2YgZGF0YSkge1xuICAgICAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwibGlcIiksXG4gICAgICAgIGNoZWNrQm94ID0gaC5odG1sKCk7XG4gICAgICBsaS5hcHBlbmRDaGlsZChjaGVja0JveCk7XG4gICAgICB1bC5hcHBlbmRDaGlsZChsaSk7XG4gICAgICBpZiAoaCBpbnN0YW5jZW9mIFBldCAmJiB0aGlzLmJlYXN0ICYmIHRoaXMuYmVhc3QuaWQgPT09IGguaWQpIHtcbiAgICAgICAgY2hlY2tCb3guZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbnB1dFwiKVswXS5jaGVja2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgaCBpbnN0YW5jZW9mIEhlcm8gJiZcbiAgICAgICAgdGhpcy5yb3N0ZXIubGVuZ3RoID4gMCAmJlxuICAgICAgICB0aGlzLnJvc3Rlci5maW5kSW5kZXgoKHgpID0+IHguaWQgPT09IGguaWQpID4gLTFcbiAgICAgICkge1xuICAgICAgICBjaGVja0JveC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImlucHV0XCIpWzBdLmNoZWNrZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQodWwpO1xuICAgIHJldHVybiBjb250YWluZXI7XG4gIH1cblxuICBoZXJvSGFuZGxlcihlOiBJbnB1dEV2ZW50KSB7XG4gICAgY29uc3QgdGcgPSBlLnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgIGNvbnN0IEhlcm8gPSBIZXJvZXMuZmluZCgoeCkgPT4geC5pZCA9PT0gcGFyc2VJbnQodGcuaWQuc3BsaXQoXCItXCIpWzFdKSk7XG5cbiAgICBpZiAodGcuY2hlY2tlZCAmJiAhdGhpcy5pc0luVGVhbShIZXJvKSkge1xuICAgICAgaWYgKCF0aGlzLmFkZChIZXJvKSkge1xuICAgICAgICB0Zy5jaGVja2VkID0gIXRnLmNoZWNrZWQ7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGcuY2hlY2tlZCAmJiB0aGlzLmlzSW5UZWFtKEhlcm8pKSB7XG4gICAgICB0aGlzLnJlbW92ZShIZXJvKTtcbiAgICB9XG4gIH1cblxuICBwZXRIYW5kbGVyKGU6IElucHV0RXZlbnQpIHtcbiAgICBjb25zdCB0ZyA9IGUudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgY29uc3QgcGV0R3JvdXAgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGAuJHtwZXRTZWxlY3RJZH0gaW5wdXRgKTtcbiAgICBjb25zdCBjbGlja2VkUGV0ID0gQmVhc3RzLmZpbmQoKHgpID0+IHgubmFtZS5pbmNsdWRlcyh0Zy5pZC5zdWJzdHJpbmcoNykpKTtcbiAgICBwZXRHcm91cC5mb3JFYWNoKCh4OiBIVE1MSW5wdXRFbGVtZW50KSA9PiB7XG4gICAgICBpZiAoIXguaWQuaW5jbHVkZXMoY2xpY2tlZFBldC5uYW1lKSkgeC5jaGVja2VkID0gZmFsc2U7XG4gICAgfSk7XG4gICAgdGhpcy5iZWFzdCA9IGNsaWNrZWRQZXQ7XG4gICAgdGcuY2hlY2tlZCA9ICF0Zy5jaGVja2VkO1xuICB9XG5cbiAgYXBwZW5kUmVzdWx0Um93KFxuICAgIGJvZHk6IEhUTUxFbGVtZW50LFxuICAgIGRwczogbnVtYmVyLFxuICAgIGR1cmFNaWdodDogbnVtYmVyLFxuICAgIGR1cmFGb3J0OiBudW1iZXIsXG4gICAgZHVyYUNlbGVyaXR5OiBudW1iZXIsXG4gICAgZHVyYVNvcmNlcnk6IG51bWJlcixcbiAgICBkdXJhU3VzdGVuYW5jZTogbnVtYmVyLFxuICAgIGM6IHN0cmluZyA9IFwiXCJcbiAgKSB7XG4gICAgY29uc3QgcmVzdWx0Um93ID0gbmV3RWwoZWxUYWcudHIpLFxuICAgICAgdGVhbSA9IG5ld0VsKGVsVGFnLnRkLCB7fSksXG4gICAgICBwZXQgPSBuZXdFbChlbFRhZy50ZCwge30pLFxuICAgICAgbWlnaHQgPSBuZXdFbChlbFRhZy50ZCwge30sIGAke2R1cmFNaWdodH1gKSxcbiAgICAgIGZvcnQgPSBuZXdFbChlbFRhZy50ZCwge30sIGAke2R1cmFGb3J0fWApLFxuICAgICAgY2VsZXJpdHkgPSBuZXdFbChlbFRhZy50ZCwge30sIGAke2R1cmFDZWxlcml0eX1gKSxcbiAgICAgIHNvcmNlcnkgPSBuZXdFbChlbFRhZy50ZCwge30sIGAke2R1cmFTb3JjZXJ5fWApLFxuICAgICAgc3VzdGVuYW5jZSA9IG5ld0VsKGVsVGFnLnRkLCB7fSwgYCR7ZHVyYVN1c3RlbmFuY2V9YCksXG4gICAgICBjb21tZW50ID0gbmV3RWwoZWxUYWcudGQsIHt9LCBjKSxcbiAgICAgIGRhbWFnZSA9IG5ld0VsKGVsVGFnLnRkLCB7fSwgYCR7ZHBzfUJgKTtcblxuICAgIHRoaXMucm9zdGVyLmZvckVhY2goKHgpID0+IHRlYW0uYXBwZW5kQ2hpbGQoeC5pbWcoKSkpO1xuICAgIHBldC5hcHBlbmRDaGlsZCh0aGlzLmJlYXN0LmltZygpKTtcblxuICAgIHJlc3VsdFJvdy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gXCJtaWRkbGVcIjtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQodGVhbSk7XG4gICAgcmVzdWx0Um93LmFwcGVuZENoaWxkKHBldCk7XG4gICAgcmVzdWx0Um93LmFwcGVuZENoaWxkKG1pZ2h0KTtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQoZm9ydCk7XG4gICAgcmVzdWx0Um93LmFwcGVuZENoaWxkKGNlbGVyaXR5KTtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQoc29yY2VyeSk7XG4gICAgcmVzdWx0Um93LmFwcGVuZENoaWxkKHN1c3RlbmFuY2UpO1xuICAgIHJlc3VsdFJvdy5hcHBlbmRDaGlsZChkYW1hZ2UpO1xuICAgIHJlc3VsdFJvdy5hcHBlbmRDaGlsZChjb21tZW50KTtcblxuICAgIHRoaXMubWFrZUF0dGFjayhkcHMsIGMpO1xuICAgIGJvZHkuYXBwZW5kQ2hpbGQocmVzdWx0Um93KTtcbiAgfVxuXG4gIG1vdW50KGVsaWQ6IHN0cmluZykge1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsaWQpLmFwcGVuZENoaWxkKHRoaXMuI3dyYXApO1xuICB9XG59XG4iXX0=