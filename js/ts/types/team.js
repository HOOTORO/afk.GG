import { fetchData, newEl, savedObj, storedValue, } from "../components/helper.js";
import { Boss, elTag } from "../model/constants.js";
import { Hero } from "./hero.js";
import { Pet } from "./pet.js";
const teamWrap = "team";
const heroSelectId = "hero-selection";
const petSelectId = "pet-sele";
export const HeroesData = await fetchData("json/heroes.json");
export const Beasts = await fetchData("json/pets.json");
const Heroes = HeroesData.map((x) => new Hero(x.id, x.icon, x.heroType, x.heroClass, x.role, x.faction, x.slug));
const puppies = Beasts.map((x) => new Pet(x.id, x.icon, x.name));
export class Team {
    team;
    beast;
    target;
    #wrap;
    roster = [];
    _max = 5;
    damage;
    food;
    constructor(mountId, team, beast, target) {
        this.team = team;
        this.beast = beast;
        this.target = target;
        const heroSaved = savedObj("team", []);
        if (heroSaved.length > 0) {
            heroSaved.forEach((v, i) => {
                this.roster.push(new Hero(v.id, v.icon, v.heroType, v.heroClass, v.role, v.faction, v.slug));
            });
        }
        this.beast = savedObj("team-pet", new Pet(0, "1", "0"));
        this.food = savedObj("min-food", 0);
        this.init(mountId);
    }
    init(mid) {
        this.#wrap = newEl(elTag.Div, { class: teamWrap });
        const allPets = this.inputsContainer(petSelectId, puppies), allHeroes = this.inputsContainer(heroSelectId, Heroes);
        this.#wrap.appendChild(allPets);
        this.#wrap.appendChild(allHeroes);
        this.#wrap.addEventListener("input", (e) => {
            if (e.target instanceof HTMLInputElement &&
                e.target.className === "beast") {
                this.petHandler(e);
            }
            else {
                this.heroHandler(e);
            }
            this.update();
        });
    }
    update() {
        storedValue("team", this.roster);
        storedValue("team-pet", this.beast);
    }
    isInTeam(hero) {
        return this.roster.findIndex((x) => x.id === hero.id) > -1;
    }
    add(h) {
        if (this.roster?.length < this._max) {
            this.roster.push(h);
            return true;
        }
        else {
            console.log("Team is full!");
            return false;
        }
    }
    remove(h) {
        const idx = this.roster.findIndex((x) => x.id === h.id);
        if (idx > -1) {
            this.roster.splice(idx, 1);
        }
    }
    makeAttack(dmg, c) {
        if (this.damage === undefined) {
            this.damage = [];
        }
        this.food -= Boss.foodCost;
        this.damage.push([dmg, c]);
    }
    inputsContainer(id, data) {
        const container = newEl("div", { class: id });
        container.appendChild(newEl("h2", {}, `CHOOSE ${id.split("-")[0].toUpperCase()}`));
        const ul = document.createElement("ul");
        for (const h of data) {
            const li = document.createElement("li"), checkBox = h.html();
            li.appendChild(checkBox);
            ul.appendChild(li);
            if (h instanceof Pet && this.beast && this.beast.id === h.id) {
                checkBox.getElementsByTagName("input")[0].checked = true;
            }
            if (h instanceof Hero &&
                this.roster.length > 0 &&
                this.roster.findIndex((x) => x.id === h.id) > -1) {
                checkBox.getElementsByTagName("input")[0].checked = true;
            }
        }
        container.appendChild(ul);
        return container;
    }
    heroHandler(e) {
        const tg = e.target;
        const Hero = Heroes.find((x) => x.id === parseInt(tg.id.split("-")[1]));
        if (tg.checked && !this.isInTeam(Hero)) {
            if (!this.add(Hero)) {
                tg.checked = !tg.checked;
            }
        }
        if (!tg.checked && this.isInTeam(Hero)) {
            this.remove(Hero);
        }
    }
    petHandler(e) {
        const tg = e.target;
        const petGroup = document.querySelectorAll(`.${petSelectId} input`);
        const clickedPet = Beasts.find((x) => x.name.includes(tg.id.substring(7)));
        petGroup.forEach((x) => {
            if (!x.id.includes(clickedPet.name))
                x.checked = false;
        });
        this.beast = clickedPet;
        tg.checked = !tg.checked;
    }
    appendResultRow(body, dps, duraMight, duraFort, duraCelerity, duraSorcery, duraSustenance, c = "") {
        const resultRow = newEl(elTag.tr), team = newEl(elTag.td, {}), pet = newEl(elTag.td, {}), might = newEl(elTag.td, {}, `${duraMight}`), fort = newEl(elTag.td, {}, `${duraFort}`), celerity = newEl(elTag.td, {}, `${duraCelerity}`), sorcery = newEl(elTag.td, {}, `${duraSorcery}`), sustenance = newEl(elTag.td, {}, `${duraSustenance}`), comment = newEl(elTag.td, {}, c), damage = newEl(elTag.td, {}, `${dps}B`);
        this.roster.forEach((x) => team.appendChild(x.img()));
        pet.appendChild(this.beast.img());
        resultRow.style.verticalAlign = "middle";
        resultRow.appendChild(team);
        resultRow.appendChild(pet);
        resultRow.appendChild(might);
        resultRow.appendChild(fort);
        resultRow.appendChild(celerity);
        resultRow.appendChild(sorcery);
        resultRow.appendChild(sustenance);
        resultRow.appendChild(damage);
        resultRow.appendChild(comment);
        this.makeAttack(dps, c);
        body.appendChild(resultRow);
    }
    mount(elid) {
        document.getElementById(elid).appendChild(this.#wrap);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy90eXBlcy90ZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLFFBQVEsRUFDUixXQUFXLEdBQ1osTUFBTSx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUUvQixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUM7QUFDeEIsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDO0FBRS9CLE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBVyxNQUFNLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3RFLE1BQU0sQ0FBQyxNQUFNLE1BQU0sR0FBVSxNQUFNLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRS9ELE1BQU0sTUFBTSxHQUFXLFVBQVUsQ0FBQyxHQUFHLENBQ25DLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDSixJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQzdFLENBQUM7QUFDRixNQUFNLE9BQU8sR0FBVSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FB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QUVELEtBQUssQ0FBQyxJQUFZO1FBQ2hCLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN4RCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBmZXRjaERhdGEsXG4gIG5ld0VsLFxuICBzYXZlZE9iaixcbiAgc3RvcmVkVmFsdWUsXG59IGZyb20gXCIuLi9jb21wb25lbnRzL2hlbHBlci5qc1wiO1xuaW1wb3J0IHsgQm9zcywgZWxUYWcgfSBmcm9tIFwiLi4vbW9kZWwvY29uc3RhbnRzLmpzXCI7XG5pbXBvcnQgeyBIZXJvIH0gZnJvbSBcIi4vaGVyby5qc1wiO1xuaW1wb3J0IHsgUGV0IH0gZnJvbSBcIi4vcGV0LmpzXCI7XG5cbmNvbnN0IHRlYW1XcmFwID0gXCJ0ZWFtXCI7XG5jb25zdCBoZXJvU2VsZWN0SWQgPSBcImhlcm8tc2VsZWN0aW9uXCI7XG5jb25zdCBwZXRTZWxlY3RJZCA9IFwicGV0LXNlbGVcIjtcblxuZXhwb3J0IGNvbnN0IEhlcm9lc0RhdGE6IEhlcm9bXSA9IGF3YWl0IGZldGNoRGF0YShcImpzb24vaGVyb2VzLmpzb25cIik7XG5leHBvcnQgY29uc3QgQmVhc3RzOiBQZXRbXSA9IGF3YWl0IGZldGNoRGF0YShcImpzb24vcGV0cy5qc29uXCIpO1xuXG5jb25zdCBIZXJvZXM6IEhlcm9bXSA9IEhlcm9lc0RhdGEubWFwKFxuICAoeCkgPT5cbiAgICBuZXcgSGVybyh4LmlkLCB4Lmljb24sIHguaGVyb1R5cGUsIHguaGVyb0NsYXNzLCB4LnJvbGUsIHguZmFjdGlvbiwgeC5zbHVnKVxuKTtcbmNvbnN0IHB1cHBpZXM6IFBldFtdID0gQmVhc3RzLm1hcCgoeCkgPT4gbmV3IFBldCh4LmlkLCB4Lmljb24sIHgubmFtZSkpO1xuXG5leHBvcnQgY2xhc3MgVGVhbSB7XG4gICN3cmFwOiBIVE1MRWxlbWVudDtcbiAgcm9zdGVyOiBIZXJvW10gPSBbXTtcbiAgcHJpdmF0ZSBfbWF4OiBudW1iZXIgPSA1O1xuICBkYW1hZ2U6IFtudW1iZXIsIHN0cmluZz9dW107XG5cbiAgZm9vZDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKG1vdW50SWQ6IHN0cmluZyk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIG1vdW50SWQ6IHN0cmluZyxcbiAgICBwdWJsaWMgdGVhbT86IEhlcm9bXSxcbiAgICBwdWJsaWMgYmVhc3Q/OiBQZXQsXG4gICAgcHVibGljIHRhcmdldD86IHN0cmluZ1xuICApIHtcbiAgICBjb25zdCBoZXJvU2F2ZWQ6IEhlcm9bXSA9IHNhdmVkT2JqKFwidGVhbVwiLCBbXSk7XG4gICAgaWYgKGhlcm9TYXZlZC5sZW5ndGggPiAwKSB7XG4gICAgICBoZXJvU2F2ZWQuZm9yRWFjaCgodiwgaSkgPT4ge1xuICAgICAgICB0aGlzLnJvc3Rlci5wdXNoKFxuICAgICAgICAgIG5ldyBIZXJvKFxuICAgICAgICAgICAgdi5pZCxcbiAgICAgICAgICAgIHYuaWNvbixcbiAgICAgICAgICAgIHYuaGVyb1R5cGUsXG4gICAgICAgICAgICB2Lmhlcm9DbGFzcyxcbiAgICAgICAgICAgIHYucm9sZSxcbiAgICAgICAgICAgIHYuZmFjdGlvbixcbiAgICAgICAgICAgIHYuc2x1Z1xuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMuYmVhc3QgPSBzYXZlZE9iaihcInRlYW0tcGV0XCIsIG5ldyBQZXQoMCwgXCIxXCIsIFwiMFwiKSk7XG4gICAgdGhpcy5mb29kID0gc2F2ZWRPYmooXCJtaW4tZm9vZFwiLCAwKTtcbiAgICB0aGlzLmluaXQobW91bnRJZCk7XG4gIH1cbiAgaW5pdChtaWQ6IHN0cmluZykge1xuICAgIHRoaXMuI3dyYXAgPSBuZXdFbChlbFRhZy5EaXYsIHsgY2xhc3M6IHRlYW1XcmFwIH0pO1xuXG4gICAgY29uc3QgYWxsUGV0cyA9IHRoaXMuaW5wdXRzQ29udGFpbmVyKHBldFNlbGVjdElkLCBwdXBwaWVzKSxcbiAgICAgIGFsbEhlcm9lcyA9IHRoaXMuaW5wdXRzQ29udGFpbmVyKGhlcm9TZWxlY3RJZCwgSGVyb2VzKTtcbiAgICB0aGlzLiN3cmFwLmFwcGVuZENoaWxkKGFsbFBldHMpO1xuICAgIHRoaXMuI3dyYXAuYXBwZW5kQ2hpbGQoYWxsSGVyb2VzKTtcblxuICAgIHRoaXMuI3dyYXAuYWRkRXZlbnRMaXN0ZW5lcihcImlucHV0XCIsIChlKSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIGUudGFyZ2V0IGluc3RhbmNlb2YgSFRNTElucHV0RWxlbWVudCAmJlxuICAgICAgICBlLnRhcmdldC5jbGFzc05hbWUgPT09IFwiYmVhc3RcIlxuICAgICAgKSB7XG4gICAgICAgIHRoaXMucGV0SGFuZGxlcihlIGFzIElucHV0RXZlbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5oZXJvSGFuZGxlcihlIGFzIElucHV0RXZlbnQpO1xuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZSgpIHtcbiAgICBzdG9yZWRWYWx1ZShcInRlYW1cIiwgdGhpcy5yb3N0ZXIpO1xuICAgIHN0b3JlZFZhbHVlKFwidGVhbS1wZXRcIiwgdGhpcy5iZWFzdCk7XG4gIH1cbiAgaXNJblRlYW0oaGVybzogSGVybyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJvc3Rlci5maW5kSW5kZXgoKHgpID0+IHguaWQgPT09IGhlcm8uaWQpID4gLTE7XG4gIH1cbiAgYWRkKGg6IEhlcm8pIHtcbiAgICBpZiAodGhpcy5yb3N0ZXI/Lmxlbmd0aCA8IHRoaXMuX21heCkge1xuICAgICAgdGhpcy5yb3N0ZXIucHVzaChoKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlRlYW0gaXMgZnVsbCFcIik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIHJlbW92ZShoOiBIZXJvKSB7XG4gICAgY29uc3QgaWR4ID0gdGhpcy5yb3N0ZXIuZmluZEluZGV4KCh4KSA9PiB4LmlkID09PSBoLmlkKTtcbiAgICBpZiAoaWR4ID4gLTEpIHtcbiAgICAgIHRoaXMucm9zdGVyLnNwbGljZShpZHgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIG1ha2VBdHRhY2soZG1nOiBudW1iZXIsIGM/OiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5kYW1hZ2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5kYW1hZ2UgPSBbXTtcbiAgICB9XG4gICAgdGhpcy5mb29kIC09IEJvc3MuZm9vZENvc3Q7XG4gICAgdGhpcy5kYW1hZ2UucHVzaChbZG1nLCBjXSk7XG4gIH1cblxuICBpbnB1dHNDb250YWluZXIoaWQ6IHN0cmluZywgZGF0YTogSGVyb1tdIHwgUGV0W10pIHtcbiAgICBjb25zdCBjb250YWluZXIgPSBuZXdFbChcImRpdlwiLCB7IGNsYXNzOiBpZCB9KTtcbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoXG4gICAgICBuZXdFbChcImgyXCIsIHt9LCBgQ0hPT1NFICR7aWQuc3BsaXQoXCItXCIpWzBdLnRvVXBwZXJDYXNlKCl9YClcbiAgICApO1xuICAgIGNvbnN0IHVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInVsXCIpO1xuICAgIGZvciAoY29uc3QgaCBvZiBkYXRhKSB7XG4gICAgICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJsaVwiKSxcbiAgICAgICAgY2hlY2tCb3ggPSBoLmh0bWwoKTtcbiAgICAgIGxpLmFwcGVuZENoaWxkKGNoZWNrQm94KTtcbiAgICAgIHVsLmFwcGVuZENoaWxkKGxpKTtcbiAgICAgIGlmIChoIGluc3RhbmNlb2YgUGV0ICYmIHRoaXMuYmVhc3QgJiYgdGhpcy5iZWFzdC5pZCA9PT0gaC5pZCkge1xuICAgICAgICBjaGVja0JveC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImlucHV0XCIpWzBdLmNoZWNrZWQgPSB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBoIGluc3RhbmNlb2YgSGVybyAmJlxuICAgICAgICB0aGlzLnJvc3Rlci5sZW5ndGggPiAwICYmXG4gICAgICAgIHRoaXMucm9zdGVyLmZpbmRJbmRleCgoeCkgPT4geC5pZCA9PT0gaC5pZCkgPiAtMVxuICAgICAgKSB7XG4gICAgICAgIGNoZWNrQm94LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiaW5wdXRcIilbMF0uY2hlY2tlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh1bCk7XG4gICAgcmV0dXJuIGNvbnRhaW5lcjtcbiAgfVxuXG4gIGhlcm9IYW5kbGVyKGU6IElucHV0RXZlbnQpIHtcbiAgICBjb25zdCB0ZyA9IGUudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgY29uc3QgSGVybyA9IEhlcm9lcy5maW5kKCh4KSA9PiB4LmlkID09PSBwYXJzZUludCh0Zy5pZC5zcGxpdChcIi1cIilbMV0pKTtcblxuICAgIGlmICh0Zy5jaGVja2VkICYmICF0aGlzLmlzSW5UZWFtKEhlcm8pKSB7XG4gICAgICBpZiAoIXRoaXMuYWRkKEhlcm8pKSB7XG4gICAgICAgIHRnLmNoZWNrZWQgPSAhdGcuY2hlY2tlZDtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKCF0Zy5jaGVja2VkICYmIHRoaXMuaXNJblRlYW0oSGVybykpIHtcbiAgICAgIHRoaXMucmVtb3ZlKEhlcm8pO1xuICAgIH1cbiAgfVxuXG4gIHBldEhhbmRsZXIoZTogSW5wdXRFdmVudCkge1xuICAgIGNvbnN0IHRnID0gZS50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudDtcbiAgICBjb25zdCBwZXRHcm91cCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYC4ke3BldFNlbGVjdElkfSBpbnB1dGApO1xuICAgIGNvbnN0IGNsaWNrZWRQZXQgPSBCZWFzdHMuZmluZCgoeCkgPT4geC5uYW1lLmluY2x1ZGVzKHRnLmlkLnN1YnN0cmluZyg3KSkpO1xuICAgIHBldEdyb3VwLmZvckVhY2goKHg6IEhUTUxJbnB1dEVsZW1lbnQpID0+IHtcbiAgICAgIGlmICgheC5pZC5pbmNsdWRlcyhjbGlja2VkUGV0Lm5hbWUpKSB4LmNoZWNrZWQgPSBmYWxzZTtcbiAgICB9KTtcbiAgICB0aGlzLmJlYXN0ID0gY2xpY2tlZFBldDtcbiAgICB0Zy5jaGVja2VkID0gIXRnLmNoZWNrZWQ7XG4gIH1cblxuICBhcHBlbmRSZXN1bHRSb3coXG4gICAgYm9keTogSFRNTEVsZW1lbnQsXG4gICAgZHBzOiBudW1iZXIsXG4gICAgZHVyYU1pZ2h0OiBudW1iZXIsXG4gICAgZHVyYUZvcnQ6IG51bWJlcixcbiAgICBkdXJhQ2VsZXJpdHk6IG51bWJlcixcbiAgICBkdXJhU29yY2VyeTogbnVtYmVyLFxuICAgIGR1cmFTdXN0ZW5hbmNlOiBudW1iZXIsXG4gICAgYzogc3RyaW5nID0gXCJcIlxuICApIHtcbiAgICBjb25zdCByZXN1bHRSb3cgPSBuZXdFbChlbFRhZy50ciksXG4gICAgICB0ZWFtID0gbmV3RWwoZWxUYWcudGQsIHt9KSxcbiAgICAgIHBldCA9IG5ld0VsKGVsVGFnLnRkLCB7fSksXG4gICAgICBtaWdodCA9IG5ld0VsKGVsVGFnLnRkLCB7fSwgYCR7ZHVyYU1pZ2h0fWApLFxuICAgICAgZm9ydCA9IG5ld0VsKGVsVGFnLnRkLCB7fSwgYCR7ZHVyYUZvcnR9YCksXG4gICAgICBjZWxlcml0eSA9IG5ld0VsKGVsVGFnLnRkLCB7fSwgYCR7ZHVyYUNlbGVyaXR5fWApLFxuICAgICAgc29yY2VyeSA9IG5ld0VsKGVsVGFnLnRkLCB7fSwgYCR7ZHVyYVNvcmNlcnl9YCksXG4gICAgICBzdXN0ZW5hbmNlID0gbmV3RWwoZWxUYWcudGQsIHt9LCBgJHtkdXJhU3VzdGVuYW5jZX1gKSxcbiAgICAgIGNvbW1lbnQgPSBuZXdFbChlbFRhZy50ZCwge30sIGMpLFxuICAgICAgZGFtYWdlID0gbmV3RWwoZWxUYWcudGQsIHt9LCBgJHtkcHN9QmApO1xuXG4gICAgdGhpcy5yb3N0ZXIuZm9yRWFjaCgoeCkgPT4gdGVhbS5hcHBlbmRDaGlsZCh4LmltZygpKSk7XG4gICAgcGV0LmFwcGVuZENoaWxkKHRoaXMuYmVhc3QuaW1nKCkpO1xuXG4gICAgcmVzdWx0Um93LnN0eWxlLnZlcnRpY2FsQWxpZ24gPSBcIm1pZGRsZVwiO1xuICAgIHJlc3VsdFJvdy5hcHBlbmRDaGlsZCh0ZWFtKTtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQocGV0KTtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQobWlnaHQpO1xuICAgIHJlc3VsdFJvdy5hcHBlbmRDaGlsZChmb3J0KTtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQoY2VsZXJpdHkpO1xuICAgIHJlc3VsdFJvdy5hcHBlbmRDaGlsZChzb3JjZXJ5KTtcbiAgICByZXN1bHRSb3cuYXBwZW5kQ2hpbGQoc3VzdGVuYW5jZSk7XG4gICAgcmVzdWx0Um93LmFwcGVuZENoaWxkKGRhbWFnZSk7XG4gICAgcmVzdWx0Um93LmFwcGVuZENoaWxkKGNvbW1lbnQpO1xuXG4gICAgdGhpcy5tYWtlQXR0YWNrKGRwcywgYyk7XG4gICAgYm9keS5hcHBlbmRDaGlsZChyZXN1bHRSb3cpO1xuICB9XG5cbiAgbW91bnQoZWxpZDogc3RyaW5nKSB7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxpZCkuYXBwZW5kQ2hpbGQodGhpcy4jd3JhcCk7XG4gIH1cbn1cbiJdfQ==