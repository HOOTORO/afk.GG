import { elTag, fetchData, newEl, safeSum as safeSum, } from "../components/helper.js";
import Inventory from "./inventory.js";
import { AbEx, RelicBase } from "../model/constants.js";
import { Settlement } from "./settlement.js";
import { Essence, Stamina } from "./abex-resource.js";
import { Tier } from "./tier.js";
const townsData = await fetchData("json/towns.json");
export class Expeditor {
    guild;
    star;
    essence = new Essence();
    stamina = new Stamina();
    captured = [];
    inventory = new Inventory();
    constructor(guild, star) {
        this.guild = guild;
        this.star = star;
        townsData.forEach((x) => {
            const s = new Settlement(x.id, x.icon, x.name, x.essencePerHour, x.yield, x.dropTier, x.dropTime);
            this.captured.push(s);
        });
    }
    EssenceIncome() {
        return safeSum(this.captured.map((x) => x.EPH()));
    }
    StamRecovery() {
        return this.star ? this.guild.StarStamRR() : this.guild.StamRecoverRate();
    }
    SilentStam() {
        return this.stamina.value + AbEx.hoursLeft() * this.StamRecovery();
    }
    ReadyToSet() {
        return this.inventory
            .goalRequired()
            .map((x) => {
            const required = () => {
                if (x.reserve > x.amount) {
                    x.reserve = x.amount;
                }
                return x.reserve;
            };
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, { class: "relic-quantity" }, `x${required()}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    TotalCaptured() {
        return this.captured
            .map((x) => x.value)
            .reduce((a, b) => a + b)
            .toString();
    }
    DropTiers() {
        return [...new Set(this.captured.map((f) => f.dropTier))]
            .map((t) => new Tier(t).html().outerHTML)
            .join("<br>");
    }
    DropTime() {
        return this.captured
            .filter((f) => f.value > 0)
            .map((x) => x.htmlInfo().outerHTML)
            .join("<br>");
    }
    ToSell() {
        return this.inventory
            .canBeSold()
            .map((x) => {
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, {}, `x${x.amount - x.reserve}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    FullPrice() {
        return this.inventory.upgradeCost();
    }
    MissEssence() {
        return (this.FullPrice() -
            this.essence.value -
            this.inventory.sellOut() -
            this.inventory.reservedValue());
    }
    futureValue() {
        let convertedDropEssValue = 0;
        this.captured.forEach((x) => {
            if (x.value > 0) {
                const avgPrice = this.inventory
                    .Relics(x.dropTier)
                    .map((v) => this.inventory.price(v))
                    .reduce((a, b) => a + b) / RelicBase;
                const wantedQuantity = this.inventory.core
                    .wanted()
                    .filter((r) => r.Tier() === x.dropTier).length;
                convertedDropEssValue += x.ConvertedDropEssValue(avgPrice, wantedQuantity);
            }
        });
        return convertedDropEssValue;
    }
    Timeleft() {
        return this.MissEssence() / (this.EssenceIncome() + this.futureValue());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3R5cGVzL2V4cGVkaXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsS0FBSyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsT0FBTyxJQUFJLE9BQU8sR0FDbkIsTUFBTSx5QkFBeUIsQ0FBQztBQUVqQyxPQUFPLFNBQVMsTUFBTSxnQkFBZ0IsQ0FBQztBQUV2QyxPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3hELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFakMsTUFBTSxTQUFTLEdBQWlCLE1BQU0sU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFbkUsTUFBTSxPQUFPLFNBQVM7SUFNRDtJQUF1QjtJQUxuQyxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUN4QixPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUN4QixRQUFRLEdBQWlCLEVBQUUsQ0FBQztJQUM1QixTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUVuQyxZQUFtQixLQUFjLEVBQVMsSUFBYTtRQUFwQyxVQUFLLEdBQUwsS0FBSyxDQUFTO1FBQVMsU0FBSSxHQUFKLElBQUksQ0FBUztRQUNyRCxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDdEIsTUFBTSxDQUFDLEdBQUcsSUFBSSxVQUFVLENBQ3RCLENBQUMsQ0FBQyxFQUFFLEVBQ0osQ0FBQyxDQUFDLElBQUksRUFDTixDQUFDLENBQUMsSUFBSSxFQUNOLENBQUMsQ0FBQyxjQUFjLEVBQ2hCLENBQUMs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QUFDO3FCQUNuQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDO2dCQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUk7cUJBQ3ZDLE1BQU0sRUFBRTtxQkFDUixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDO2dCQUNqRCxxQkFBcUIsSUFBSSxDQUFDLENBQUMscUJBQXFCLENBQzlDLFFBQVEsRUFDUixjQUFjLENBQ2YsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8scUJBQXFCLENBQUM7SUFDL0IsQ0FBQztJQUNNLFFBQVE7UUFDYixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztJQUMxRSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBlbFRhZyxcbiAgZmV0Y2hEYXRhLFxuICBuZXdFbCxcbiAgc2FmZVN1bSBhcyBzYWZlU3VtLFxufSBmcm9tIFwiLi4vY29tcG9uZW50cy9oZWxwZXIuanNcIjtcblxuaW1wb3J0IEludmVudG9yeSBmcm9tIFwiLi9pbnZlbnRvcnkuanNcIjtcbmltcG9ydCB7IE1pbGl0aWEgfSBmcm9tIFwiLi9taWxpdGlhLmpzXCI7XG5pbXBvcnQgeyBBYkV4LCBSZWxpY0Jhc2UgfSBmcm9tIFwiLi4vbW9kZWwvY29uc3RhbnRzLmpzXCI7XG5pbXBvcnQgeyBTZXR0bGVtZW50IH0gZnJvbSBcIi4vc2V0dGxlbWVudC5qc1wiO1xuaW1wb3J0IHsgRXNzZW5jZSwgU3RhbWluYSB9IGZyb20gXCIuL2FiZXgtcmVzb3VyY2UuanNcIjtcbmltcG9ydCB7IFRpZXIgfSBmcm9tIFwiLi90aWVyLmpzXCI7XG5cbmNvbnN0IHRvd25zRGF0YTogU2V0dGxlbWVudFtdID0gYXdhaXQgZmV0Y2hEYXRhKFwianNvbi90b3ducy5qc29uXCIpO1xuXG5leHBvcnQgY2xhc3MgRXhwZWRpdG9yIHtcbiAgcHVibGljIGVzc2VuY2UgPSBuZXcgRXNzZW5jZSgpO1xuICBwdWJsaWMgc3RhbWluYSA9IG5ldyBTdGFtaW5hKCk7XG4gIHB1YmxpYyBjYXB0dXJlZDogU2V0dGxlbWVudFtdID0gW107XG4gIHB1YmxpYyBpbnZlbnRvcnkgPSBuZXcgSW52ZW50b3J5KCk7XG4gIC8vIElOSVRJQUxJWkFUSU9OLCBTRVRURVJTL0dFVFRFUlNcbiAgY29uc3RydWN0b3IocHVibGljIGd1aWxkOiBNaWxpdGlhLCBwdWJsaWMgc3RhcjogYm9vbGVhbikge1xuICAgIHRvd25zRGF0YS5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICBjb25zdCBzID0gbmV3IFNldHRsZW1lbnQoXG4gICAgICAgIHguaWQsXG4gICAgICAgIHguaWNvbixcbiAgICAgICAgeC5uYW1lLFxuICAgICAgICB4LmVzc2VuY2VQZXJIb3VyLFxuICAgICAgICB4LnlpZWxkLFxuICAgICAgICB4LmRyb3BUaWVyLFxuICAgICAgICB4LmRyb3BUaW1lXG4gICAgICApO1xuICAgICAgdGhpcy5jYXB0dXJlZC5wdXNoKHMpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gTUVUSE9EU1xuXG4gIEVzc2VuY2VJbmNvbWUoKSB7XG4gICAgcmV0dXJuIHNhZmVTdW0odGhpcy5jYXB0dXJlZC5tYXAoKHgpID0+IHguRVBIKCkpKTtcbiAgfVxuXG4gIFN0YW1SZWNvdmVyeSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnN0YXIgPyB0aGlzLmd1aWxkLlN0YXJTdGFtUlIoKSA6IHRoaXMuZ3VpbGQuU3RhbVJlY292ZXJSYXRlKCk7XG4gIH1cbiAgU2lsZW50U3RhbSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnN0YW1pbmEudmFsdWUgKyBBYkV4LmhvdXJzTGVmdCgpICogdGhpcy5TdGFtUmVjb3ZlcnkoKTtcbiAgfVxuICBSZWFkeVRvU2V0KCkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVxuICAgICAgLmdvYWxSZXF1aXJlZCgpXG4gICAgICAubWFwKCh4KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVpcmVkID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4LnJlc2VydmUgPiB4LmFtb3VudCkge1xuICAgICAgICAgICAgeC5yZXNlcnZlID0geC5hbW91bnQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB4LnJlc2VydmU7XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGMgPSB4Lmh0bWwoKTtcbiAgICAgICAgYy5jbGFzc05hbWUgPSBcInRhYmxlLXRleHRcIjtcbiAgICAgICAgLy8gVE9ETzpcbiAgICAgICAgLy8gPyBob3cgaXQgd29yayBub3cgLT4gb24gaG92ZXIgaW4ga2VlcCBzZWN0aW9uLCBzaG93IHJlY2lwZSBvZiBob3ZlciByZWxpYy5cbiAgICAgICAgLy8gKiBUaGF0J3MgbWFrZSBubyBzZW5zZSwgaXQgc2hvdWxkIGJlIGhpZ2hlciByZWxpY3Mgd2hlcmUgaG92ZXJlZCBvbmUgdXNlc1xuICAgICAgICAvLyBjLmFwcGVuZENoaWxkKFxuICAgICAgICAvLyAgIG5ld0VsKFxuICAgICAgICAvLyAgICAgZWxUYWcuRGl2LFxuICAgICAgICAvLyAgICAgeyBjbGFzczogXCJyZWxpYy10b29sdGlwXCIgfSxcbiAgICAgICAgLy8gICAgIHRoaXMuaW52ZW50b3J5LmNvbXBvbmVudHNEaWEoeCkub3V0ZXJIVE1MXG4gICAgICAgIC8vICAgKVxuICAgICAgICAvLyApO1xuICAgICAgICBjLmFwcGVuZENoaWxkKFxuICAgICAgICAgIG5ld0VsKGVsVGFnLlNwYW4sIHsgY2xhc3M6IFwicmVsaWMtcXVhbnRpdHlcIiB9LCBgeCR7cmVxdWlyZWQoKX1gKVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gYy5vdXRlckhUTUw7XG4gICAgICB9KVxuICAgICAgLmpvaW4oXCIgXCIpO1xuICB9XG4gIFRvdGFsQ2FwdHVyZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FwdHVyZWRcbiAgICAgIC5tYXAoKHgpID0+IHgudmFsdWUpXG4gICAgICAucmVkdWNlKChhLCBiKSA9PiBhICsgYilcbiAgICAgIC50b1N0cmluZygpO1xuICB9XG4gIERyb3BUaWVycygpIHtcbiAgICByZXR1cm4gWy4uLm5ldyBTZXQodGhpcy5jYXB0dXJlZC5tYXAoKGYpID0+IGYuZHJvcFRpZXIpKV1cbiAgICAgIC5tYXAoKHQpID0+IG5ldyBUaWVyKHQpLmh0bWwoKS5vdXRlckhUTUwpXG4gICAgICAuam9pbihcIjxicj5cIik7XG4gIH1cbiAgRHJvcFRpbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FwdHVyZWRcbiAgICAgIC5maWx0ZXIoKGYpID0+IGYudmFsdWUgPiAwKVxuICAgICAgLm1hcCgoeCkgPT4geC5odG1sSW5mbygpLm91dGVySFRNTClcbiAgICAgIC5qb2luKFwiPGJyPlwiKTtcbiAgfVxuXG4gIFRvU2VsbCgpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlcbiAgICAgIC5jYW5CZVNvbGQoKVxuICAgICAgLm1hcCgoeCkgPT4ge1xuICAgICAgICBjb25zdCBjID0geC5odG1sKCk7XG4gICAgICAgIGMuY2xhc3NOYW1lID0gXCJ0YWJsZS10ZXh0XCI7XG4gICAgICAgIGMuYXBwZW5kQ2hpbGQobmV3RWwoZWxUYWcuU3Bhbiwge30sIGB4JHt4LmFtb3VudCAtIHgucmVzZXJ2ZX1gKSk7XG4gICAgICAgIHJldHVybiBjLm91dGVySFRNTDtcbiAgICAgIH0pXG4gICAgICAuam9pbihcIiBcIik7XG4gIH1cbiAgRnVsbFByaWNlKCkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeS51cGdyYWRlQ29zdCgpO1xuICB9XG5cbiAgTWlzc0Vzc2VuY2UoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuRnVsbFByaWNlKCkgLVxuICAgICAgdGhpcy5lc3NlbmNlLnZhbHVlIC1cbiAgICAgIHRoaXMuaW52ZW50b3J5LnNlbGxPdXQoKSAtXG4gICAgICB0aGlzLmludmVudG9yeS5yZXNlcnZlZFZhbHVlKClcbiAgICApO1xuICB9XG4gIGZ1dHVyZVZhbHVlKCkge1xuICAgIGxldCBjb252ZXJ0ZWREcm9wRXNzVmFsdWUgPSAwO1xuICAgIHRoaXMuY2FwdHVyZWQuZm9yRWFjaCgoeCkgPT4ge1xuICAgICAgaWYgKHgudmFsdWUgPiAwKSB7XG4gICAgICAgIGNvbnN0IGF2Z1ByaWNlID1cbiAgICAgICAgICB0aGlzLmludmVudG9yeVxuICAgICAgICAgICAgLlJlbGljcyh4LmRyb3BUaWVyKVxuICAgICAgICAgICAgLm1hcCgodikgPT4gdGhpcy5pbnZlbnRvcnkucHJpY2UodikpXG4gICAgICAgICAgICAucmVkdWNlKChhLCBiKSA9PiBhICsgYikgLyBSZWxpY0Jhc2U7XG4gICAgICAgIGNvbnN0IHdhbnRlZFF1YW50aXR5ID0gdGhpcy5pbnZlbnRvcnkuY29yZVxuICAgICAgICAgIC53YW50ZWQoKVxuICAgICAgICAgIC5maWx0ZXIoKHIpID0+IHIuVGllcigpID09PSB4LmRyb3BUaWVyKS5sZW5ndGg7XG4gICAgICAgIGNvbnZlcnRlZERyb3BFc3NWYWx1ZSArPSB4LkNvbnZlcnRlZERyb3BFc3NWYWx1ZShcbiAgICAgICAgICBhdmdQcmljZSxcbiAgICAgICAgICB3YW50ZWRRdWFudGl0eVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjb252ZXJ0ZWREcm9wRXNzVmFsdWU7XG4gIH1cbiAgcHVibGljIFRpbWVsZWZ0KCkge1xuICAgIHJldHVybiB0aGlzLk1pc3NFc3NlbmNlKCkgLyAodGhpcy5Fc3NlbmNlSW5jb21lKCkgKyB0aGlzLmZ1dHVyZVZhbHVlKCkpO1xuICB9XG59XG4iXX0=