import { fetchData, newEl, safeSum as safeSum } from "../components/helper.js";
import Inventory from "./inventory.js";
import { AbEx, elTag, RelicBase } from "../model/constants.js";
import { Settlement } from "./settlement.js";
import { Essence, Stamina, StarOfDawn } from "./abex-resource.js";
import { Tier } from "./tier.js";
import { Virtue } from "./virtue.js";
const townsData = await fetchData("json/towns.json");
export const TreeData = await fetchData("json/duratree.json");
export class Expeditor {
    guild;
    essence = new Essence();
    stamina = new Stamina();
    captured = [];
    inventory = new Inventory();
    star = new StarOfDawn();
    DuraTree = [];
    constructor(guild, star) {
        this.guild = guild;
        townsData.forEach((x) => {
            const s = new Settlement(x.id, x.icon, x.name, x.essencePerHour, x.yield, x.dropTier, x.dropTime);
            this.captured.push(s);
        });
        this.star.status = star;
        this.DuraTree.push(...TreeData.map((x) => new Virtue(x.icon, x.name, x.id, x.class, x.acronym)));
    }
    EssenceIncome() {
        return safeSum(this.captured.map((x) => x.EPH()));
    }
    StamRecovery() {
        return this.guild.StamIncome(this.star.hasSpectator);
    }
    SilentStam() {
        return this.stamina.value + AbEx.hoursLeft() * this.StamRecovery();
    }
    ReadyToSet() {
        return this.inventory
            .goalRequired()
            .map((x) => {
            const required = () => {
                if (x.reserve > x.amount) {
                    x.reserve = x.amount;
                }
                return x.reserve;
            };
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, { class: "relic-quantity" }, `x${required()}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    TotalCaptured() {
        return this.captured
            .map((x) => x.value)
            .reduce((a, b) => a + b)
            .toString();
    }
    DropTiers() {
        return [...new Set(this.captured.map((f) => f.dropTier))]
            .map((t) => new Tier(t).html().outerHTML)
            .join("<br>");
    }
    DropTime() {
        return this.captured
            .filter((f) => f.value > 0)
            .map((x) => x.htmlInfo().outerHTML)
            .join("<br>");
    }
    ToSell() {
        return this.inventory
            .canBeSold()
            .map((x) => {
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, {}, `x${x.amount - x.reserve}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    FullPrice() {
        return this.inventory.upgradeCost();
    }
    MissEssence() {
        return (this.FullPrice() -
            this.essence.value -
            this.inventory.sellOut() -
            this.inventory.reservedValue());
    }
    futureValue() {
        let convertedDropEssValue = 1;
        this.captured.forEach((x) => {
            if (x.value > 0) {
                const avgPrice = this.inventory
                    .Relics(x.dropTier)
                    .map((v) => this.inventory.price(v))
                    .reduce((a, b) => a + b) / RelicBase;
                const wantedQuantity = this.inventory.core
                    .wanted()
                    .filter((r) => r.Tier() === x.dropTier).length;
                convertedDropEssValue += x.ConvertedDropEssValue(avgPrice, wantedQuantity);
            }
        });
        return convertedDropEssValue;
    }
    Timeleft() {
        return this.MissEssence() / (this.EssenceIncome() + this.futureValue());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3R5cGVzL2V4cGVkaXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxPQUFPLElBQUksT0FBTyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFL0UsT0FBTyxTQUFTLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkMsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVyQyxNQUFNLFNBQVMsR0FBaUIsTUFBTSxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUNuRSxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQWEsTUFBTSxTQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUV4RSxNQUFNLE9BQU8sU0FBUztJQVFEO0lBUFosT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDeEIsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDeEIsUUFBUSxHQUFpQixFQUFFLENBQUM7SUFDNUIsU0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7SUFDNUIsSUFBSSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7SUFDeEIsUUFBUSxHQUFhLEVBQUUsQ0FBQztJQUUvQixZQUFtQixLQUFjLEVBQUUsSUFBYTtRQUE3QixVQUFLLEdBQUwsS0FBSyxDQUFTO1FBQy9CLFNBQVMsQ0FBQyxPQUFPLENBQUMs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Y2hEYXRhLCBuZXdFbCwgc2FmZVN1bSBhcyBzYWZlU3VtIH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvaGVscGVyLmpzXCI7XG5cbmltcG9ydCBJbnZlbnRvcnkgZnJvbSBcIi4vaW52ZW50b3J5LmpzXCI7XG5pbXBvcnQgeyBNaWxpdGlhIH0gZnJvbSBcIi4vbWlsaXRpYS5qc1wiO1xuaW1wb3J0IHsgQWJFeCwgZWxUYWcsIFJlbGljQmFzZSB9IGZyb20gXCIuLi9tb2RlbC9jb25zdGFudHMuanNcIjtcbmltcG9ydCB7IFNldHRsZW1lbnQgfSBmcm9tIFwiLi9zZXR0bGVtZW50LmpzXCI7XG5pbXBvcnQgeyBFc3NlbmNlLCBTdGFtaW5hLCBTdGFyT2ZEYXduIH0gZnJvbSBcIi4vYWJleC1yZXNvdXJjZS5qc1wiO1xuaW1wb3J0IHsgVGllciB9IGZyb20gXCIuL3RpZXIuanNcIjtcbmltcG9ydCB7IFZpcnR1ZSB9IGZyb20gXCIuL3ZpcnR1ZS5qc1wiO1xuXG5jb25zdCB0b3duc0RhdGE6IFNldHRsZW1lbnRbXSA9IGF3YWl0IGZldGNoRGF0YShcImpzb24vdG93bnMuanNvblwiKTtcbmV4cG9ydCBjb25zdCBUcmVlRGF0YTogVmlydHVlW10gPSBhd2FpdCBmZXRjaERhdGEoXCJqc29uL2R1cmF0cmVlLmpzb25cIik7XG5cbmV4cG9ydCBjbGFzcyBFeHBlZGl0b3Ige1xuICBwdWJsaWMgZXNzZW5jZSA9IG5ldyBFc3NlbmNlKCk7XG4gIHB1YmxpYyBzdGFtaW5hID0gbmV3IFN0YW1pbmEoKTtcbiAgcHVibGljIGNhcHR1cmVkOiBTZXR0bGVtZW50W10gPSBbXTtcbiAgcHVibGljIGludmVudG9yeSA9IG5ldyBJbnZlbnRvcnkoKTtcbiAgcHVibGljIHN0YXIgPSBuZXcgU3Rhck9mRGF3bigpO1xuICBwdWJsaWMgRHVyYVRyZWU6IFZpcnR1ZVtdID0gW107XG4gIC8vIElOSVRJQUxJWkFUSU9OLCBTRVRURVJTL0dFVFRFUlNcbiAgY29uc3RydWN0b3IocHVibGljIGd1aWxkOiBNaWxpdGlhLCBzdGFyOiBib29sZWFuKSB7XG4gICAgdG93bnNEYXRhLmZvckVhY2goKHgpID0+IHtcbiAgICAgIGNvbnN0IHMgPSBuZXcgU2V0dGxlbWVudChcbiAgICAgICAgeC5pZCxcbiAgICAgICAgeC5pY29uLFxuICAgICAgICB4Lm5hbWUsXG4gICAgICAgIHguZXNzZW5jZVBlckhvdXIsXG4gICAgICAgIHgueWllbGQsXG4gICAgICAgIHguZHJvcFRpZXIsXG4gICAgICAgIHguZHJvcFRpbWVcbiAgICAgICk7XG4gICAgICB0aGlzLmNhcHR1cmVkLnB1c2gocyk7XG4gICAgfSk7XG4gICAgdGhpcy5zdGFyLnN0YXR1cyA9IHN0YXI7XG4gICAgdGhpcy5EdXJhVHJlZS5wdXNoKFxuICAgICAgLi4uVHJlZURhdGEubWFwKFxuICAgICAgICAoeCkgPT4gbmV3IFZpcnR1ZSh4Lmljb24sIHgubmFtZSwgeC5pZCwgeC5jbGFzcywgeC5hY3JvbnltKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICAvLyBNRVRIT0RTXG5cbiAgRXNzZW5jZUluY29tZSgpIHtcbiAgICByZXR1cm4gc2FmZVN1bSh0aGlzLmNhcHR1cmVkLm1hcCgoeCkgPT4geC5FUEgoKSkpO1xuICB9XG5cbiAgU3RhbVJlY292ZXJ5KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZ3VpbGQuU3RhbUluY29tZSh0aGlzLnN0YXIuaGFzU3BlY3RhdG9yKTtcbiAgfVxuICBTaWxlbnRTdGFtKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuc3RhbWluYS52YWx1ZSArIEFiRXguaG91cnNMZWZ0KCkgKiB0aGlzLlN0YW1SZWNvdmVyeSgpO1xuICB9XG4gIFJlYWR5VG9TZXQoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5XG4gICAgICAuZ29hbFJlcXVpcmVkKClcbiAgICAgIC5tYXAoKHgpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWlyZWQgPSAoKSA9PiB7XG4gICAgICAgICAgaWYgKHgucmVzZXJ2ZSA+IHguYW1vdW50KSB7XG4gICAgICAgICAgICB4LnJlc2VydmUgPSB4LmFtb3VudDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHgucmVzZXJ2ZTtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgYyA9IHguaHRtbCgpO1xuICAgICAgICBjLmNsYXNzTmFtZSA9IFwidGFibGUtdGV4dFwiO1xuICAgICAgICAvLyBUT0RPOlxuICAgICAgICAvLyA/IGhvdyBpdCB3b3JrIG5vdyAtPiBvbiBob3ZlciBpbiBrZWVwIHNlY3Rpb24sIHNob3cgcmVjaXBlIG9mIGhvdmVyIHJlbGljLlxuICAgICAgICAvLyAqIFRoYXQncyBtYWtlIG5vIHNlbnNlLCBpdCBzaG91bGQgYmUgaGlnaGVyIHJlbGljcyB3aGVyZSBob3ZlcmVkIG9uZSB1c2VzXG4gICAgICAgIC8vIGMuYXBwZW5kQ2hpbGQoXG4gICAgICAgIC8vICAgbmV3RWwoXG4gICAgICAgIC8vICAgICBlbFRhZy5EaXYsXG4gICAgICAgIC8vICAgICB7IGNsYXNzOiBcInJlbGljLXRvb2x0aXBcIiB9LFxuICAgICAgICAvLyAgICAgdGhpcy5pbnZlbnRvcnkuY29tcG9uZW50c0RpYSh4KS5vdXRlckhUTUxcbiAgICAgICAgLy8gICApXG4gICAgICAgIC8vICk7XG4gICAgICAgIGMuYXBwZW5kQ2hpbGQoXG4gICAgICAgICAgbmV3RWwoZWxUYWcuU3BhbiwgeyBjbGFzczogXCJyZWxpYy1xdWFudGl0eVwiIH0sIGB4JHtyZXF1aXJlZCgpfWApXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBjLm91dGVySFRNTDtcbiAgICAgIH0pXG4gICAgICAuam9pbihcIiBcIik7XG4gIH1cbiAgVG90YWxDYXB0dXJlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5jYXB0dXJlZFxuICAgICAgLm1hcCgoeCkgPT4geC52YWx1ZSlcbiAgICAgIC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiKVxuICAgICAgLnRvU3RyaW5nKCk7XG4gIH1cbiAgRHJvcFRpZXJzKCkge1xuICAgIHJldHVybiBbLi4ubmV3IFNldCh0aGlzLmNhcHR1cmVkLm1hcCgoZikgPT4gZi5kcm9wVGllcikpXVxuICAgICAgLm1hcCgodCkgPT4gbmV3IFRpZXIodCkuaHRtbCgpLm91dGVySFRNTClcbiAgICAgIC5qb2luKFwiPGJyPlwiKTtcbiAgfVxuICBEcm9wVGltZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jYXB0dXJlZFxuICAgICAgLmZpbHRlcigoZikgPT4gZi52YWx1ZSA+IDApXG4gICAgICAubWFwKCh4KSA9PiB4Lmh0bWxJbmZvKCkub3V0ZXJIVE1MKVxuICAgICAgLmpvaW4oXCI8YnI+XCIpO1xuICB9XG5cbiAgVG9TZWxsKCkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVxuICAgICAgLmNhbkJlU29sZCgpXG4gICAgICAubWFwKCh4KSA9PiB7XG4gICAgICAgIGNvbnN0IGMgPSB4Lmh0bWwoKTtcbiAgICAgICAgYy5jbGFzc05hbWUgPSBcInRhYmxlLXRleHRcIjtcbiAgICAgICAgYy5hcHBlbmRDaGlsZChuZXdFbChlbFRhZy5TcGFuLCB7fSwgYHgke3guYW1vdW50IC0geC5yZXNlcnZlfWApKTtcbiAgICAgICAgcmV0dXJuIGMub3V0ZXJIVE1MO1xuICAgICAgfSlcbiAgICAgIC5qb2luKFwiIFwiKTtcbiAgfVxuICBGdWxsUHJpY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LnVwZ3JhZGVDb3N0KCk7XG4gIH1cblxuICBNaXNzRXNzZW5jZSgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5GdWxsUHJpY2UoKSAtXG4gICAgICB0aGlzLmVzc2VuY2UudmFsdWUgLVxuICAgICAgdGhpcy5pbnZlbnRvcnkuc2VsbE91dCgpIC1cbiAgICAgIHRoaXMuaW52ZW50b3J5LnJlc2VydmVkVmFsdWUoKVxuICAgICk7XG4gIH1cbiAgZnV0dXJlVmFsdWUoKSB7XG4gICAgbGV0IGNvbnZlcnRlZERyb3BFc3NWYWx1ZSA9IDE7XG4gICAgdGhpcy5jYXB0dXJlZC5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICBpZiAoeC52YWx1ZSA+IDApIHtcbiAgICAgICAgY29uc3QgYXZnUHJpY2UgPVxuICAgICAgICAgIHRoaXMuaW52ZW50b3J5XG4gICAgICAgICAgICAuUmVsaWNzKHguZHJvcFRpZXIpXG4gICAgICAgICAgICAubWFwKCh2KSA9PiB0aGlzLmludmVudG9yeS5wcmljZSh2KSlcbiAgICAgICAgICAgIC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiKSAvIFJlbGljQmFzZTtcbiAgICAgICAgY29uc3Qgd2FudGVkUXVhbnRpdHkgPSB0aGlzLmludmVudG9yeS5jb3JlXG4gICAgICAgICAgLndhbnRlZCgpXG4gICAgICAgICAgLmZpbHRlcigocikgPT4gci5UaWVyKCkgPT09IHguZHJvcFRpZXIpLmxlbmd0aDtcbiAgICAgICAgY29udmVydGVkRHJvcEVzc1ZhbHVlICs9IHguQ29udmVydGVkRHJvcEVzc1ZhbHVlKFxuICAgICAgICAgIGF2Z1ByaWNlLFxuICAgICAgICAgIHdhbnRlZFF1YW50aXR5XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbnZlcnRlZERyb3BFc3NWYWx1ZTtcbiAgfVxuICBwdWJsaWMgVGltZWxlZnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuTWlzc0Vzc2VuY2UoKSAvICh0aGlzLkVzc2VuY2VJbmNvbWUoKSArIHRoaXMuZnV0dXJlVmFsdWUoKSk7XG4gIH1cbn1cbiJdfQ==