import { fetchData, newEl, safeSum as safeSum } from "../components/helper.js";
import Inventory from "./inventory.js";
import { AbEx, Boss, elTag, RelicBase } from "../model/constants.js";
import { Settlement } from "./settlement.js";
import { Essence, Stamina, StarOfDawn } from "./abex-resource.js";
import { Tier } from "./tier.js";
import { Virtue } from "./virtue.js";
const townsData = await fetchData("json/towns.json");
export const TreeData = await fetchData("json/duratree.json");
export class Expeditor {
    guild;
    essence = new Essence();
    stamina = new Stamina();
    captured = [];
    inventory = new Inventory();
    star = new StarOfDawn();
    DuraTree = [];
    constructor(guild, star) {
        this.guild = guild;
        townsData.forEach((x) => {
            const s = new Settlement(x.id, x.icon, x.name, x.essencePerHour, x.yield, x.dropTier, x.dropTime);
            this.captured.push(s);
        });
        this.star.status = star;
        this.DuraTree.push(...TreeData.map((x) => new Virtue(x.icon, x.name, x.id, x.class, x.acronym)));
        if (this.essence.hoursSinceLastUpdate > 0) {
            this.essence.value =
                this.essence.value +
                    this.EssenceIncome() * this.essence.hoursSinceLastUpdate;
            this.essence.lastUpdate = new Date();
        }
    }
    BossAttack() {
        this.stamina.value -= Boss.foodCost;
    }
    EssenceIncome() {
        return safeSum(this.captured.map((x) => x.EPH()));
    }
    StamRecovery() {
        return this.guild.StamIncome(this.star.hasSpectator);
    }
    SilentStam() {
        return this.stamina.value + AbEx.hoursLeft() * this.StamRecovery();
    }
    ReadyToSet() {
        return this.inventory
            .goalRequired()
            .map((x) => {
            const required = () => {
                if (x.reserve > x.amount) {
                    x.reserve = x.amount;
                }
                return x.reserve;
            };
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, { class: "relic-quantity" }, `x${required()}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    TotalCaptured() {
        return this.captured
            .map((x) => x.value)
            .reduce((a, b) => a + b)
            .toString();
    }
    DropTiers() {
        return [...new Set(this.captured.map((f) => f.dropTier))]
            .map((t) => new Tier(t).html().outerHTML)
            .join("<br>");
    }
    DropTime() {
        return this.captured
            .filter((f) => f.value > 0)
            .map((x) => x.htmlInfo().outerHTML)
            .join("<br>");
    }
    ToSell() {
        return this.inventory
            .canBeSold()
            .map((x) => {
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, {}, `x${x.amount - x.reserve}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    FullPrice() {
        return this.inventory.upgradeCost();
    }
    MissEssence() {
        return (this.FullPrice() -
            this.essence.value -
            this.inventory.sellOut() -
            this.inventory.reservedValue());
    }
    futureValue() {
        let convertedDropEssValue = 1;
        this.captured.forEach((x) => {
            if (x.value > 0) {
                const avgPrice = this.inventory
                    .Relics(x.dropTier)
                    .map((v) => this.inventory.price(v))
                    .reduce((a, b) => a + b) / RelicBase;
                const wantedQuantity = this.inventory.core
                    .wanted()
                    .filter((r) => r.Tier() === x.dropTier).length;
                convertedDropEssValue += x.ConvertedDropEssValue(avgPrice, wantedQuantity);
            }
        });
        return convertedDropEssValue;
    }
    Timeleft() {
        return this.MissEssence() / (this.EssenceIncome() + this.futureValue());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3R5cGVzL2V4cGVkaXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxPQUFPLElBQUksT0FBTyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFL0UsT0FBTyxTQUFTLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFckMsTUFBTSxTQUFTLEdBQWlCLE1BQU0sU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDbkUsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFhLE1BQU0sU0FBUyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFFeEUsTUFBTSxPQUFPLFNBQVM7SUFRRDtJQVBaLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQ3hCLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQ3hCLFFBQVEsR0FBaUIsRUFBRSxDQUFDO0lBQzVCLFNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO0lBQzVCLElBQUksR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBQ3hCLFFBQVEsR0FBYSxFQUFFLENBQUM7SUFFL0IsWUFBbUIsS0FBYyxFQUFFLElBQWE7UUFBN0IsVUFBSyxHQUFMLEtBQUssQ0FBUztRQUMvQixTQUFTLENBQUMs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QUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7Z0JBQ2pELHFCQUFxQixJQUFJLENBQUMsQ0FBQyxxQkFBcUIsQ0FDOUMsUUFBUSxFQUNSLGNBQWMsQ0FDZixDQUFDO1lBQ0osQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxxQkFBcUIsQ0FBQztJQUMvQixDQUFDO0lBQ00sUUFBUTtRQUNiLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQzFFLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZldGNoRGF0YSwgbmV3RWwsIHNhZmVTdW0gYXMgc2FmZVN1bSB9IGZyb20gXCIuLi9jb21wb25lbnRzL2hlbHBlci5qc1wiO1xuXG5pbXBvcnQgSW52ZW50b3J5IGZyb20gXCIuL2ludmVudG9yeS5qc1wiO1xuaW1wb3J0IHsgTWlsaXRpYSB9IGZyb20gXCIuL21pbGl0aWEuanNcIjtcbmltcG9ydCB7IEFiRXgsIEJvc3MsIGVsVGFnLCBSZWxpY0Jhc2UgfSBmcm9tIFwiLi4vbW9kZWwvY29uc3RhbnRzLmpzXCI7XG5pbXBvcnQgeyBTZXR0bGVtZW50IH0gZnJvbSBcIi4vc2V0dGxlbWVudC5qc1wiO1xuaW1wb3J0IHsgRXNzZW5jZSwgU3RhbWluYSwgU3Rhck9mRGF3biB9IGZyb20gXCIuL2FiZXgtcmVzb3VyY2UuanNcIjtcbmltcG9ydCB7IFRpZXIgfSBmcm9tIFwiLi90aWVyLmpzXCI7XG5pbXBvcnQgeyBWaXJ0dWUgfSBmcm9tIFwiLi92aXJ0dWUuanNcIjtcblxuY29uc3QgdG93bnNEYXRhOiBTZXR0bGVtZW50W10gPSBhd2FpdCBmZXRjaERhdGEoXCJqc29uL3Rvd25zLmpzb25cIik7XG5leHBvcnQgY29uc3QgVHJlZURhdGE6IFZpcnR1ZVtdID0gYXdhaXQgZmV0Y2hEYXRhKFwianNvbi9kdXJhdHJlZS5qc29uXCIpO1xuXG5leHBvcnQgY2xhc3MgRXhwZWRpdG9yIHtcbiAgcHVibGljIGVzc2VuY2UgPSBuZXcgRXNzZW5jZSgpO1xuICBwdWJsaWMgc3RhbWluYSA9IG5ldyBTdGFtaW5hKCk7XG4gIHB1YmxpYyBjYXB0dXJlZDogU2V0dGxlbWVudFtdID0gW107XG4gIHB1YmxpYyBpbnZlbnRvcnkgPSBuZXcgSW52ZW50b3J5KCk7XG4gIHB1YmxpYyBzdGFyID0gbmV3IFN0YXJPZkRhd24oKTtcbiAgcHVibGljIER1cmFUcmVlOiBWaXJ0dWVbXSA9IFtdO1xuICAvLyBJTklUSUFMSVpBVElPTiwgU0VUVEVSUy9HRVRURVJTXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBndWlsZDogTWlsaXRpYSwgc3RhcjogYm9vbGVhbikge1xuICAgIHRvd25zRGF0YS5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICBjb25zdCBzID0gbmV3IFNldHRsZW1lbnQoXG4gICAgICAgIHguaWQsXG4gICAgICAgIHguaWNvbixcbiAgICAgICAgeC5uYW1lLFxuICAgICAgICB4LmVzc2VuY2VQZXJIb3VyLFxuICAgICAgICB4LnlpZWxkLFxuICAgICAgICB4LmRyb3BUaWVyLFxuICAgICAgICB4LmRyb3BUaW1lXG4gICAgICApO1xuICAgICAgdGhpcy5jYXB0dXJlZC5wdXNoKHMpO1xuICAgIH0pO1xuICAgIHRoaXMuc3Rhci5zdGF0dXMgPSBzdGFyO1xuICAgIHRoaXMuRHVyYVRyZWUucHVzaChcbiAgICAgIC4uLlRyZWVEYXRhLm1hcChcbiAgICAgICAgKHgpID0+IG5ldyBWaXJ0dWUoeC5pY29uLCB4Lm5hbWUsIHguaWQsIHguY2xhc3MsIHguYWNyb255bSlcbiAgICAgIClcbiAgICApO1xuICAgIGlmICh0aGlzLmVzc2VuY2UuaG91cnNTaW5jZUxhc3RVcGRhdGUgPiAwKSB7XG4gICAgICB0aGlzLmVzc2VuY2UudmFsdWUgPVxuICAgICAgICB0aGlzLmVzc2VuY2UudmFsdWUgK1xuICAgICAgICB0aGlzLkVzc2VuY2VJbmNvbWUoKSAqIHRoaXMuZXNzZW5jZS5ob3Vyc1NpbmNlTGFzdFVwZGF0ZTtcbiAgICAgIHRoaXMuZXNzZW5jZS5sYXN0VXBkYXRlID0gbmV3IERhdGUoKTtcbiAgICB9XG4gIH1cblxuICAvLyBNRVRIT0RTXG5cbiAgQm9zc0F0dGFjaygpIHtcbiAgICB0aGlzLnN0YW1pbmEudmFsdWUgLT0gQm9zcy5mb29kQ29zdDtcbiAgfVxuXG4gIEVzc2VuY2VJbmNvbWUoKSB7XG4gICAgcmV0dXJuIHNhZmVTdW0odGhpcy5jYXB0dXJlZC5tYXAoKHgpID0+IHguRVBIKCkpKTtcbiAgfVxuXG4gIFN0YW1SZWNvdmVyeSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmd1aWxkLlN0YW1JbmNvbWUodGhpcy5zdGFyLmhhc1NwZWN0YXRvcik7XG4gIH1cbiAgU2lsZW50U3RhbSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnN0YW1pbmEudmFsdWUgKyBBYkV4LmhvdXJzTGVmdCgpICogdGhpcy5TdGFtUmVjb3ZlcnkoKTtcbiAgfVxuICBSZWFkeVRvU2V0KCkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVxuICAgICAgLmdvYWxSZXF1aXJlZCgpXG4gICAgICAubWFwKCh4KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVpcmVkID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4LnJlc2VydmUgPiB4LmFtb3VudCkge1xuICAgICAgICAgICAgeC5yZXNlcnZlID0geC5hbW91bnQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB4LnJlc2VydmU7XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGMgPSB4Lmh0bWwoKTtcbiAgICAgICAgYy5jbGFzc05hbWUgPSBcInRhYmxlLXRleHRcIjtcbiAgICAgICAgLy8gVE9ETzpcbiAgICAgICAgLy8gPyBob3cgaXQgd29yayBub3cgLT4gb24gaG92ZXIgaW4ga2VlcCBzZWN0aW9uLCBzaG93IHJlY2lwZSBvZiBob3ZlciByZWxpYy5cbiAgICAgICAgLy8gKiBUaGF0J3MgbWFrZSBubyBzZW5zZSwgaXQgc2hvdWxkIGJlIGhpZ2hlciByZWxpY3Mgd2hlcmUgaG92ZXJlZCBvbmUgdXNlc1xuICAgICAgICAvLyBjLmFwcGVuZENoaWxkKFxuICAgICAgICAvLyAgIG5ld0VsKFxuICAgICAgICAvLyAgICAgZWxUYWcuRGl2LFxuICAgICAgICAvLyAgICAgeyBjbGFzczogXCJyZWxpYy10b29sdGlwXCIgfSxcbiAgICAgICAgLy8gICAgIHRoaXMuaW52ZW50b3J5LmNvbXBvbmVudHNEaWEoeCkub3V0ZXJIVE1MXG4gICAgICAgIC8vICAgKVxuICAgICAgICAvLyApO1xuICAgICAgICBjLmFwcGVuZENoaWxkKFxuICAgICAgICAgIG5ld0VsKGVsVGFnLlNwYW4sIHsgY2xhc3M6IFwicmVsaWMtcXVhbnRpdHlcIiB9LCBgeCR7cmVxdWlyZWQoKX1gKVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gYy5vdXRlckhUTUw7XG4gICAgICB9KVxuICAgICAgLmpvaW4oXCIgXCIpO1xuICB9XG4gIFRvdGFsQ2FwdHVyZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FwdHVyZWRcbiAgICAgIC5tYXAoKHgpID0+IHgudmFsdWUpXG4gICAgICAucmVkdWNlKChhLCBiKSA9PiBhICsgYilcbiAgICAgIC50b1N0cmluZygpO1xuICB9XG4gIERyb3BUaWVycygpIHtcbiAgICByZXR1cm4gWy4uLm5ldyBTZXQodGhpcy5jYXB0dXJlZC5tYXAoKGYpID0+IGYuZHJvcFRpZXIpKV1cbiAgICAgIC5tYXAoKHQpID0+IG5ldyBUaWVyKHQpLmh0bWwoKS5vdXRlckhUTUwpXG4gICAgICAuam9pbihcIjxicj5cIik7XG4gIH1cbiAgRHJvcFRpbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FwdHVyZWRcbiAgICAgIC5maWx0ZXIoKGYpID0+IGYudmFsdWUgPiAwKVxuICAgICAgLm1hcCgoeCkgPT4geC5odG1sSW5mbygpLm91dGVySFRNTClcbiAgICAgIC5qb2luKFwiPGJyPlwiKTtcbiAgfVxuXG4gIFRvU2VsbCgpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlcbiAgICAgIC5jYW5CZVNvbGQoKVxuICAgICAgLm1hcCgoeCkgPT4ge1xuICAgICAgICBjb25zdCBjID0geC5odG1sKCk7XG4gICAgICAgIGMuY2xhc3NOYW1lID0gXCJ0YWJsZS10ZXh0XCI7XG4gICAgICAgIGMuYXBwZW5kQ2hpbGQobmV3RWwoZWxUYWcuU3Bhbiwge30sIGB4JHt4LmFtb3VudCAtIHgucmVzZXJ2ZX1gKSk7XG4gICAgICAgIHJldHVybiBjLm91dGVySFRNTDtcbiAgICAgIH0pXG4gICAgICAuam9pbihcIiBcIik7XG4gIH1cbiAgRnVsbFByaWNlKCkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeS51cGdyYWRlQ29zdCgpO1xuICB9XG5cbiAgTWlzc0Vzc2VuY2UoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuRnVsbFByaWNlKCkgLVxuICAgICAgdGhpcy5lc3NlbmNlLnZhbHVlIC1cbiAgICAgIHRoaXMuaW52ZW50b3J5LnNlbGxPdXQoKSAtXG4gICAgICB0aGlzLmludmVudG9yeS5yZXNlcnZlZFZhbHVlKClcbiAgICApO1xuICB9XG4gIGZ1dHVyZVZhbHVlKCkge1xuICAgIGxldCBjb252ZXJ0ZWREcm9wRXNzVmFsdWUgPSAxO1xuICAgIHRoaXMuY2FwdHVyZWQuZm9yRWFjaCgoeCkgPT4ge1xuICAgICAgaWYgKHgudmFsdWUgPiAwKSB7XG4gICAgICAgIGNvbnN0IGF2Z1ByaWNlID1cbiAgICAgICAgICB0aGlzLmludmVudG9yeVxuICAgICAgICAgICAgLlJlbGljcyh4LmRyb3BUaWVyKVxuICAgICAgICAgICAgLm1hcCgodikgPT4gdGhpcy5pbnZlbnRvcnkucHJpY2UodikpXG4gICAgICAgICAgICAucmVkdWNlKChhLCBiKSA9PiBhICsgYikgLyBSZWxpY0Jhc2U7XG4gICAgICAgIGNvbnN0IHdhbnRlZFF1YW50aXR5ID0gdGhpcy5pbnZlbnRvcnkuY29yZVxuICAgICAgICAgIC53YW50ZWQoKVxuICAgICAgICAgIC5maWx0ZXIoKHIpID0+IHIuVGllcigpID09PSB4LmRyb3BUaWVyKS5sZW5ndGg7XG4gICAgICAgIGNvbnZlcnRlZERyb3BFc3NWYWx1ZSArPSB4LkNvbnZlcnRlZERyb3BFc3NWYWx1ZShcbiAgICAgICAgICBhdmdQcmljZSxcbiAgICAgICAgICB3YW50ZWRRdWFudGl0eVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjb252ZXJ0ZWREcm9wRXNzVmFsdWU7XG4gIH1cbiAgcHVibGljIFRpbWVsZWZ0KCkge1xuICAgIHJldHVybiB0aGlzLk1pc3NFc3NlbmNlKCkgLyAodGhpcy5Fc3NlbmNlSW5jb21lKCkgKyB0aGlzLmZ1dHVyZVZhbHVlKCkpO1xuICB9XG59XG4iXX0=