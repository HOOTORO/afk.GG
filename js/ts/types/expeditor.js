import { fetchData, newEl, safeSum as safeSum } from "../components/helper.js";
import Inventory from "./inventory.js";
import { AbEx, elTag, RelicBase } from "../model/constants.js";
import { Settlement } from "./settlement.js";
import { Essence, Stamina, StarOfDawn } from "./abex-resource.js";
import { Tier } from "./tier.js";
import { Virtue } from "./virtue.js";
import { BossManager } from "./boss.js";
const townsData = await fetchData("json/towns.json");
export const TreeData = await fetchData("json/duratree.json");
export class Expeditor {
    guild;
    essence = new Essence();
    stamina = new Stamina();
    captured = [];
    inventory = new Inventory();
    star = new StarOfDawn();
    DuraTree = [];
    constructor(guild, star) {
        this.guild = guild;
        townsData.forEach((x) => {
            const s = new Settlement(x.id, x.icon, x.name, x.essencePerHour, x.yield, x.dropTier, x.dropTime);
            this.captured.push(s);
        });
        this.star.status = star;
        this.DuraTree.push(...TreeData.map((x) => new Virtue(x.icon, x.name, x.id, x.class, x.acronym)));
        if (this.essence.hoursSinceLastUpdate > 0) {
            this.essence.value =
                this.essence.value +
                    this.EssenceIncome() * this.essence.hoursSinceLastUpdate;
            this.essence.lastUpdate = new Date();
        }
    }
    BossAttack() {
        this.stamina.value -= BossManager.foodCost;
    }
    EssenceIncome() {
        return safeSum(this.captured.map((x) => x.EPH()));
    }
    StamRecovery() {
        return this.guild.StamIncome(this.star.hasSpectator);
    }
    SilentStam() {
        return this.stamina.value + AbEx.hoursLeft() * this.StamRecovery();
    }
    ReadyToSet() {
        return this.inventory
            .goalRequired()
            .map((x) => {
            const required = () => {
                if (x.reserve > x.amount) {
                    x.reserve = x.amount;
                }
                return x.reserve;
            };
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, { class: "relic-quantity" }, `x${required()}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    TotalCaptured() {
        return this.captured
            .map((x) => x.value)
            .reduce((a, b) => a + b)
            .toString();
    }
    DropTiers() {
        return [...new Set(this.captured.map((f) => f.dropTier))]
            .map((t) => new Tier(t).html().outerHTML)
            .join("<br>");
    }
    DropTime() {
        return this.captured
            .filter((f) => f.value > 0)
            .map((x) => x.htmlInfo().outerHTML)
            .join("<br>");
    }
    ToSell() {
        return this.inventory
            .canBeSold()
            .map((x) => {
            const c = x.html();
            c.className = "table-text";
            c.appendChild(newEl(elTag.Span, {}, `x${x.amount - x.reserve}`));
            return c.outerHTML;
        })
            .join(" ");
    }
    FullPrice() {
        return this.inventory.upgradeCost();
    }
    MissEssence() {
        return (this.FullPrice() -
            this.essence.value -
            this.inventory.sellOut() -
            this.inventory.reservedValue());
    }
    futureValue() {
        let convertedDropEssValue = 1;
        this.captured.forEach((x) => {
            if (x.value > 0) {
                const avgPrice = this.inventory
                    .Relics(x.dropTier)
                    .map((v) => this.inventory.price(v))
                    .reduce((a, b) => a + b) / RelicBase;
                const wantedQuantity = this.inventory.core
                    .wanted()
                    .filter((r) => r.Tier() === x.dropTier).length;
                convertedDropEssValue += x.ConvertedDropEssValue(avgPrice, wantedQuantity);
            }
        });
        return convertedDropEssValue;
    }
    Timeleft() {
        return this.MissEssence() / (this.EssenceIncome() + this.futureValue());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3R5cGVzL2V4cGVkaXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxPQUFPLElBQUksT0FBTyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFL0UsT0FBTyxTQUFTLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkMsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXhDLE1BQU0sU0FBUyxHQUFpQixNQUFNLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ25FLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBYSxNQUFNLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBRXhFLE1BQU0sT0FBTyxTQUFTO0lBUUQ7SUFQWixPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUN4QixPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUN4QixRQUFRLEdBQWlCLEVBQUUsQ0FBQztJQUM1QixTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUM1QixJQUFJLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztJQUN4QixRQUFRLEdBQWEsRUFBRSxDQUFDO0lBRS9CLFlBQW1CLEtBQWMsRUFBRSxJQUFhO1FBQTdCLFVBQUss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Q0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDO2dCQUNqRCxxQkFBcUIsSUFBSSxDQUFDLENBQUMscUJBQXFCLENBQzlDLFFBQVEsRUFDUixjQUFjLENBQ2YsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8scUJBQXFCLENBQUM7SUFDL0IsQ0FBQztJQUNNLFFBQVE7UUFDYixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztJQUMxRSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmZXRjaERhdGEsIG5ld0VsLCBzYWZlU3VtIGFzIHNhZmVTdW0gfSBmcm9tIFwiLi4vY29tcG9uZW50cy9oZWxwZXIuanNcIjtcblxuaW1wb3J0IEludmVudG9yeSBmcm9tIFwiLi9pbnZlbnRvcnkuanNcIjtcbmltcG9ydCB7IE1pbGl0aWEgfSBmcm9tIFwiLi9taWxpdGlhLmpzXCI7XG5pbXBvcnQgeyBBYkV4LCBlbFRhZywgUmVsaWNCYXNlIH0gZnJvbSBcIi4uL21vZGVsL2NvbnN0YW50cy5qc1wiO1xuaW1wb3J0IHsgU2V0dGxlbWVudCB9IGZyb20gXCIuL3NldHRsZW1lbnQuanNcIjtcbmltcG9ydCB7IEVzc2VuY2UsIFN0YW1pbmEsIFN0YXJPZkRhd24gfSBmcm9tIFwiLi9hYmV4LXJlc291cmNlLmpzXCI7XG5pbXBvcnQgeyBUaWVyIH0gZnJvbSBcIi4vdGllci5qc1wiO1xuaW1wb3J0IHsgVmlydHVlIH0gZnJvbSBcIi4vdmlydHVlLmpzXCI7XG5pbXBvcnQgeyBCb3NzTWFuYWdlciB9IGZyb20gXCIuL2Jvc3MuanNcIjtcblxuY29uc3QgdG93bnNEYXRhOiBTZXR0bGVtZW50W10gPSBhd2FpdCBmZXRjaERhdGEoXCJqc29uL3Rvd25zLmpzb25cIik7XG5leHBvcnQgY29uc3QgVHJlZURhdGE6IFZpcnR1ZVtdID0gYXdhaXQgZmV0Y2hEYXRhKFwianNvbi9kdXJhdHJlZS5qc29uXCIpO1xuXG5leHBvcnQgY2xhc3MgRXhwZWRpdG9yIHtcbiAgcHVibGljIGVzc2VuY2UgPSBuZXcgRXNzZW5jZSgpO1xuICBwdWJsaWMgc3RhbWluYSA9IG5ldyBTdGFtaW5hKCk7XG4gIHB1YmxpYyBjYXB0dXJlZDogU2V0dGxlbWVudFtdID0gW107XG4gIHB1YmxpYyBpbnZlbnRvcnkgPSBuZXcgSW52ZW50b3J5KCk7XG4gIHB1YmxpYyBzdGFyID0gbmV3IFN0YXJPZkRhd24oKTtcbiAgcHVibGljIER1cmFUcmVlOiBWaXJ0dWVbXSA9IFtdO1xuICAvLyBJTklUSUFMSVpBVElPTiwgU0VUVEVSUy9HRVRURVJTXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBndWlsZDogTWlsaXRpYSwgc3RhcjogYm9vbGVhbikge1xuICAgIHRvd25zRGF0YS5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICBjb25zdCBzID0gbmV3IFNldHRsZW1lbnQoXG4gICAgICAgIHguaWQsXG4gICAgICAgIHguaWNvbixcbiAgICAgICAgeC5uYW1lLFxuICAgICAgICB4LmVzc2VuY2VQZXJIb3VyLFxuICAgICAgICB4LnlpZWxkLFxuICAgICAgICB4LmRyb3BUaWVyLFxuICAgICAgICB4LmRyb3BUaW1lXG4gICAgICApO1xuICAgICAgdGhpcy5jYXB0dXJlZC5wdXNoKHMpO1xuICAgIH0pO1xuICAgIHRoaXMuc3Rhci5zdGF0dXMgPSBzdGFyO1xuICAgIHRoaXMuRHVyYVRyZWUucHVzaChcbiAgICAgIC4uLlRyZWVEYXRhLm1hcChcbiAgICAgICAgKHgpID0+IG5ldyBWaXJ0dWUoeC5pY29uLCB4Lm5hbWUsIHguaWQsIHguY2xhc3MsIHguYWNyb255bSlcbiAgICAgIClcbiAgICApO1xuICAgIGlmICh0aGlzLmVzc2VuY2UuaG91cnNTaW5jZUxhc3RVcGRhdGUgPiAwKSB7XG4gICAgICB0aGlzLmVzc2VuY2UudmFsdWUgPVxuICAgICAgICB0aGlzLmVzc2VuY2UudmFsdWUgK1xuICAgICAgICB0aGlzLkVzc2VuY2VJbmNvbWUoKSAqIHRoaXMuZXNzZW5jZS5ob3Vyc1NpbmNlTGFzdFVwZGF0ZTtcbiAgICAgIHRoaXMuZXNzZW5jZS5sYXN0VXBkYXRlID0gbmV3IERhdGUoKTtcbiAgICB9XG4gIH1cblxuICAvLyBNRVRIT0RTXG5cbiAgQm9zc0F0dGFjaygpIHtcbiAgICB0aGlzLnN0YW1pbmEudmFsdWUgLT0gQm9zc01hbmFnZXIuZm9vZENvc3Q7XG4gIH1cblxuICBFc3NlbmNlSW5jb21lKCkge1xuICAgIHJldHVybiBzYWZlU3VtKHRoaXMuY2FwdHVyZWQubWFwKCh4KSA9PiB4LkVQSCgpKSk7XG4gIH1cblxuICBTdGFtUmVjb3ZlcnkoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5ndWlsZC5TdGFtSW5jb21lKHRoaXMuc3Rhci5oYXNTcGVjdGF0b3IpO1xuICB9XG4gIFNpbGVudFN0YW0oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5zdGFtaW5hLnZhbHVlICsgQWJFeC5ob3Vyc0xlZnQoKSAqIHRoaXMuU3RhbVJlY292ZXJ5KCk7XG4gIH1cbiAgUmVhZHlUb1NldCgpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlcbiAgICAgIC5nb2FsUmVxdWlyZWQoKVxuICAgICAgLm1hcCgoeCkgPT4ge1xuICAgICAgICBjb25zdCByZXF1aXJlZCA9ICgpID0+IHtcbiAgICAgICAgICBpZiAoeC5yZXNlcnZlID4geC5hbW91bnQpIHtcbiAgICAgICAgICAgIHgucmVzZXJ2ZSA9IHguYW1vdW50O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4geC5yZXNlcnZlO1xuICAgICAgICB9O1xuICAgICAgICBjb25zdCBjID0geC5odG1sKCk7XG4gICAgICAgIGMuY2xhc3NOYW1lID0gXCJ0YWJsZS10ZXh0XCI7XG4gICAgICAgIC8vIFRPRE86XG4gICAgICAgIC8vID8gaG93IGl0IHdvcmsgbm93IC0+IG9uIGhvdmVyIGluIGtlZXAgc2VjdGlvbiwgc2hvdyByZWNpcGUgb2YgaG92ZXIgcmVsaWMuXG4gICAgICAgIC8vICogVGhhdCdzIG1ha2Ugbm8gc2Vuc2UsIGl0IHNob3VsZCBiZSBoaWdoZXIgcmVsaWNzIHdoZXJlIGhvdmVyZWQgb25lIHVzZXNcbiAgICAgICAgLy8gYy5hcHBlbmRDaGlsZChcbiAgICAgICAgLy8gICBuZXdFbChcbiAgICAgICAgLy8gICAgIGVsVGFnLkRpdixcbiAgICAgICAgLy8gICAgIHsgY2xhc3M6IFwicmVsaWMtdG9vbHRpcFwiIH0sXG4gICAgICAgIC8vICAgICB0aGlzLmludmVudG9yeS5jb21wb25lbnRzRGlhKHgpLm91dGVySFRNTFxuICAgICAgICAvLyAgIClcbiAgICAgICAgLy8gKTtcbiAgICAgICAgYy5hcHBlbmRDaGlsZChcbiAgICAgICAgICBuZXdFbChlbFRhZy5TcGFuLCB7IGNsYXNzOiBcInJlbGljLXF1YW50aXR5XCIgfSwgYHgke3JlcXVpcmVkKCl9YClcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIGMub3V0ZXJIVE1MO1xuICAgICAgfSlcbiAgICAgIC5qb2luKFwiIFwiKTtcbiAgfVxuICBUb3RhbENhcHR1cmVkKCkge1xuICAgIHJldHVybiB0aGlzLmNhcHR1cmVkXG4gICAgICAubWFwKCh4KSA9PiB4LnZhbHVlKVxuICAgICAgLnJlZHVjZSgoYSwgYikgPT4gYSArIGIpXG4gICAgICAudG9TdHJpbmcoKTtcbiAgfVxuICBEcm9wVGllcnMoKSB7XG4gICAgcmV0dXJuIFsuLi5uZXcgU2V0KHRoaXMuY2FwdHVyZWQubWFwKChmKSA9PiBmLmRyb3BUaWVyKSldXG4gICAgICAubWFwKCh0KSA9PiBuZXcgVGllcih0KS5odG1sKCkub3V0ZXJIVE1MKVxuICAgICAgLmpvaW4oXCI8YnI+XCIpO1xuICB9XG4gIERyb3BUaW1lKCkge1xuICAgIHJldHVybiB0aGlzLmNhcHR1cmVkXG4gICAgICAuZmlsdGVyKChmKSA9PiBmLnZhbHVlID4gMClcbiAgICAgIC5tYXAoKHgpID0+IHguaHRtbEluZm8oKS5vdXRlckhUTUwpXG4gICAgICAuam9pbihcIjxicj5cIik7XG4gIH1cblxuICBUb1NlbGwoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5XG4gICAgICAuY2FuQmVTb2xkKClcbiAgICAgIC5tYXAoKHgpID0+IHtcbiAgICAgICAgY29uc3QgYyA9IHguaHRtbCgpO1xuICAgICAgICBjLmNsYXNzTmFtZSA9IFwidGFibGUtdGV4dFwiO1xuICAgICAgICBjLmFwcGVuZENoaWxkKG5ld0VsKGVsVGFnLlNwYW4sIHt9LCBgeCR7eC5hbW91bnQgLSB4LnJlc2VydmV9YCkpO1xuICAgICAgICByZXR1cm4gYy5vdXRlckhUTUw7XG4gICAgICB9KVxuICAgICAgLmpvaW4oXCIgXCIpO1xuICB9XG4gIEZ1bGxQcmljZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkudXBncmFkZUNvc3QoKTtcbiAgfVxuXG4gIE1pc3NFc3NlbmNlKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLkZ1bGxQcmljZSgpIC1cbiAgICAgIHRoaXMuZXNzZW5jZS52YWx1ZSAtXG4gICAgICB0aGlzLmludmVudG9yeS5zZWxsT3V0KCkgLVxuICAgICAgdGhpcy5pbnZlbnRvcnkucmVzZXJ2ZWRWYWx1ZSgpXG4gICAgKTtcbiAgfVxuICBmdXR1cmVWYWx1ZSgpIHtcbiAgICBsZXQgY29udmVydGVkRHJvcEVzc1ZhbHVlID0gMTtcbiAgICB0aGlzLmNhcHR1cmVkLmZvckVhY2goKHgpID0+IHtcbiAgICAgIGlmICh4LnZhbHVlID4gMCkge1xuICAgICAgICBjb25zdCBhdmdQcmljZSA9XG4gICAgICAgICAgdGhpcy5pbnZlbnRvcnlcbiAgICAgICAgICAgIC5SZWxpY3MoeC5kcm9wVGllcilcbiAgICAgICAgICAgIC5tYXAoKHYpID0+IHRoaXMuaW52ZW50b3J5LnByaWNlKHYpKVxuICAgICAgICAgICAgLnJlZHVjZSgoYSwgYikgPT4gYSArIGIpIC8gUmVsaWNCYXNlO1xuICAgICAgICBjb25zdCB3YW50ZWRRdWFudGl0eSA9IHRoaXMuaW52ZW50b3J5LmNvcmVcbiAgICAgICAgICAud2FudGVkKClcbiAgICAgICAgICAuZmlsdGVyKChyKSA9PiByLlRpZXIoKSA9PT0geC5kcm9wVGllcikubGVuZ3RoO1xuICAgICAgICBjb252ZXJ0ZWREcm9wRXNzVmFsdWUgKz0geC5Db252ZXJ0ZWREcm9wRXNzVmFsdWUoXG4gICAgICAgICAgYXZnUHJpY2UsXG4gICAgICAgICAgd2FudGVkUXVhbnRpdHlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY29udmVydGVkRHJvcEVzc1ZhbHVlO1xuICB9XG4gIHB1YmxpYyBUaW1lbGVmdCgpIHtcbiAgICByZXR1cm4gdGhpcy5NaXNzRXNzZW5jZSgpIC8gKHRoaXMuRXNzZW5jZUluY29tZSgpICsgdGhpcy5mdXR1cmVWYWx1ZSgpKTtcbiAgfVxufVxuIl19